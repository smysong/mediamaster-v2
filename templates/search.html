<!-- templates/search.html -->
{% extends "base.html" %}
{% block title %}搜索结果{% endblock %}
{% block content %}
<style>
    /* 分组标题 */
    .section-title {        
        border-left: 4px solid #4770dc;        
        padding-left: 10px;        
        margin: 20px 0 15px 0;        
        font-weight: 600;
    }

    /* 海报卡片 */
    .media-card {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        background: #fff;
        height: 100%;
        width: 190px;
        display: flex;
        flex-direction: column;
    }

    .media-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .media-poster {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 10px 10px 0 0;
        object-position: center center; /* 明确指定水平和垂直居中 */
    }

    .media-info {
        padding: 10px;
    }

    .media-title {
        font-weight: bold;
        font-size: 0.95rem;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .media-year {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 4px;
    }

    .seasons-info {
        font-size: 0.75rem;
        color: #888;
    }

    /* 海报墙布局 */
    .poster-wall {
        display: grid;
        gap: 1.2rem;
        justify-items: center;
        align-items: start;
        grid-template-columns: repeat(auto-fill, 190px);
    }

    /* 演员和导演信息样式 */
    .modal-credits {
        margin-top: 20px;
        border-top: 1px solid #dee2e6;
        padding-top: 20px;
    }

    .credits-section h5 {
        margin-bottom: 15px;
        font-weight: 600;
    }

    .persons-list {
        display: flex;
        flex-wrap: wrap;
        gap: 12px; /* 稍微减小间距 */
    }

    .person-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 65px; /* 减小卡片宽度 */
        text-align: center;
    }

    .person-image {
        width: 50px; /* 减小头像尺寸 */
        height: 50px;
        border-radius: 50%;
        overflow: hidden;
        margin-bottom: 6px; /* 减小间距 */
    }

    .person-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .person-info {
        font-size: 0.7rem; /* 减小整体字体大小 */
        width: 100%;
    }

    .person-name {
        font-weight: 600;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
        font-size: 0.75rem; /* 调整名字字体大小 */
    }

    .person-role {
        color: #666;
        font-size: 0.65rem; /* 调整角色字体大小 */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
    }

    /* 小屏幕设备适配 */
    @media (max-width: 768px) {
        .person-card {
            width: 55px; /* 进一步减小宽度 */
        }
        
        .person-image {
            width: 40px;
            height: 40px;
        }
        
        .person-info {
            font-size: 0.65rem;
        }
        
        .person-name {
            font-size: 0.7rem;
        }
        
        .person-role {
            font-size: 0.55rem;
        }
        
        .persons-list {
            gap: 10px;
        }
    }

    @media (max-width: 576px) {
        .person-card {
            width: 50px;
        }
        
        .person-image {
            width: 35px;
            height: 35px;
        }
        
        .person-info {
            font-size: 0.6rem;
        }
        
        .person-name {
            font-size: 0.65rem;
        }
        
        .person-role {
            font-size: 0.5rem;
        }
        
        .persons-list {
            gap: 8px;
        }
    }

    /* 小屏幕设备 (平板竖屏) */
    @media (min-width: 576px) {
        .poster-wall {
            grid-template-columns: repeat(auto-fill, 190px);
        }
        
        .media-poster {
            height: 230px;
            object-position: center center;
        }
    }

    /* 中等屏幕设备 (平板横屏/小笔记本) */
    @media (min-width: 768px) {
        .poster-wall {
            grid-template-columns: repeat(auto-fill, 190px);
        }
        
        .media-poster {
            height: 220px;
            object-position: center center;
        }
        
        .media-title {
            font-size: 0.9rem;
        }
    }

    /* 大屏幕设备 (桌面) */
    @media (min-width: 992px) {
        .poster-wall {
            grid-template-columns: repeat(auto-fill, 190px);
        }
        
        .media-poster {
            height: 240px;
            object-position: center center;
        }
    }

    /* 超大屏幕设备 */
    @media (min-width: 1200px) {
        .poster-wall {
            grid-template-columns: repeat(auto-fill, 190px);
            gap: 1.5rem;
        }
        
        .media-poster {
            height: 260px;
            object-position: center center;
        }
        
        .media-title {
            font-size: 1rem;
        }
    }

    /* 手机横屏优化 */
    @media (min-width: 576px) and (max-width: 767px) and (orientation: landscape) {
        .media-poster {
            height: 180px;
            object-position: center center;
        }
        
        .media-title {
            font-size: 0.85rem;
        }
        
        .media-year, .seasons-info {
            font-size: 0.7rem;
        }
    }

    /* 模态框样式调整 */
    .modal-poster img {
        max-width: 200px;
        max-height: 300px;
        border-radius: 5px;
    }

    @media (max-width: 768px) {
        .modal-poster img {
            max-width: 150px;
            max-height: 225px;
        }
    }
</style>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-12">
            <h4 class="mb-4">搜索结果: "{{ query }}"</h4>
            
            <!-- 加载指示器 -->
            <div id="loading" class="text-center" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
            
            <!-- 搜索结果 -->
            <div id="search-results" style="display: none;">
                <!-- 电影结果 -->
                <div id="movie-section">
                    <h5 class="section-title">电影</h5>
                    <div id="movie-results" class="poster-wall"></div>
                </div>
                
                <!-- 电视结果 -->
                <div id="tv-section">
                    <h5 class="section-title">电视</h5>
                    <div id="tv-results" class="poster-wall"></div>
                </div>
            </div>
            
            <!-- 无结果提示 -->
            <div id="no-results" class="text-center" style="display: none; margin-top: 50px;">
                <div class="alert alert-info" role="alert">
                    <h5><i class="bi bi-info-circle"></i> 没有找到匹配的结果</h5>
                    <p class="mb-0">请尝试使用其他关键词进行搜索</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 海报详情模态框 -->
<div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaModalLabel">媒体详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-column flex-md-row">
                    <div class="modal-poster mb-3 mb-md-0">
                        <img id="modal-poster-img" src="" alt="海报">
                    </div>
                    <div class="modal-details flex-grow-1">
                        <h3 id="modal-title" style="font-weight: 600;"></h3>
                        <p id="modal-year"></p>
                        <p id="modal-genres"></p>
                        <p id="modal-rating"></p>
                        <div id="modal-seasons" class="mt-3"></div>
                    </div>
                </div>
                <div class="modal-overview mt-3">
                    <h5>简介</h5>
                    <p id="modal-overview"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const query = new URLSearchParams(window.location.search).get('q');
    if (query) {
        performSearch(query);
    }
});

async function performSearch(query) {
    // 显示加载指示器
    document.getElementById('loading').style.display = 'block';
    document.getElementById('search-results').style.display = 'none';
    document.getElementById('no-results').style.display = 'none';
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        // 隐藏加载指示器
        document.getElementById('loading').style.display = 'none';
        
        if (data.results.movies.length > 0 || data.results.tvs.length > 0) {
            document.getElementById('search-results').style.display = 'block';
            renderResults(data);
        } else {
            document.getElementById('no-results').style.display = 'block';
        }
    } catch (error) {
        console.error('搜索出错:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('no-results').style.display = 'block';
    }
}

async function renderResults(data) {
    // 获取TMDB配置信息
    const tmdbConfig = data.tmdb_config;
    const apiKey = tmdbConfig.tmdb_api_key;
    
    // 使用固定的TMDB图片基础URL
    const imageBaseUrl = "https://image.tmdb.org/t/p/w300";
    
    // 渲染电影结果
    const movieResults = document.getElementById('movie-results');
    movieResults.innerHTML = '';
    
    if (data.results.movies.length > 0) {
        document.getElementById('movie-section').style.display = 'block';
        for (const movie of data.results.movies) {
            const movieCard = await createMediaCard(movie, 'movie', imageBaseUrl, apiKey);
            movieResults.appendChild(movieCard);
        }
    } else {
        document.getElementById('movie-section').style.display = 'none';
    }
    
    // 渲染电视剧结果
    const tvResults = document.getElementById('tv-results');
    tvResults.innerHTML = '';
    
    if (data.results.tvs.length > 0) {
        document.getElementById('tv-section').style.display = 'block';
        for (const tv of data.results.tvs) {
            const tvCard = await createMediaCard(tv, 'tv', imageBaseUrl, apiKey);
            tvResults.appendChild(tvCard);
        }
    } else {
        document.getElementById('tv-section').style.display = 'none';
    }
}

// 将连续的数字数组转换为范围表示
function formatEpisodeRanges(episodesStr) {
    if (!episodesStr) return '';
    
    // 解析集数字符串为数字数组并排序
    const episodes = episodesStr.split(',')
        .map(e => parseInt(e.trim()))
        .filter(e => !isNaN(e))
        .sort((a, b) => a - b);
    
    if (episodes.length === 0) return '';
    
    const ranges = [];
    let start = episodes[0];
    let end = episodes[0];
    
    for (let i = 1; i < episodes.length; i++) {
        if (episodes[i] === end + 1) {
            // 连续的数字
            end = episodes[i];
        } else {
            // 不连续，保存当前范围
            if (start === end) {
                ranges.push(start.toString());
            } else {
                ranges.push(`${start}-${end}`);
            }
            // 开始新的范围
            start = episodes[i];
            end = episodes[i];
        }
    }
    
    // 添加最后一个范围
    if (start === end) {
        ranges.push(start.toString());
    } else {
        ranges.push(`${start}-${end}`);
    }
    
    return ranges.join(',');
}

// 计算缺失的集数
function findMissingEpisodes(episodesStr) {
    if (!episodesStr) return [];
    
    // 解析集数字符串为数字数组并排序
    const episodes = episodesStr.split(',')
        .map(e => parseInt(e.trim()))
        .filter(e => !isNaN(e))
        .sort((a, b) => a - b);
    
    if (episodes.length === 0) return [];
    
    const missing = [];
    const min = Math.min(...episodes);
    const max = Math.max(...episodes);
    
    // 查找范围内的缺失集数
    for (let i = min; i <= max; i++) {
        if (!episodes.includes(i)) {
            missing.push(i);
        }
    }
    
    return missing;
}

// 格式化缺失集数显示
function formatMissingEpisodes(missingEpisodes) {
    if (missingEpisodes.length === 0) return '';
    
    // 使用与formatEpisodeRanges相同的方法来格式化缺失集数
    const ranges = [];
    let start = missingEpisodes[0];
    let end = missingEpisodes[0];
    
    for (let i = 1; i < missingEpisodes.length; i++) {
        if (missingEpisodes[i] === end + 1) {
            // 连续的数字
            end = missingEpisodes[i];
        } else {
            // 不连续，保存当前范围
            if (start === end) {
                ranges.push(start.toString());
            } else {
                ranges.push(`${start}-${end}`);
            }
            // 开始新的范围
            start = missingEpisodes[i];
            end = missingEpisodes[i];
        }
    }
    
    // 添加最后一个范围
    if (start === end) {
        ranges.push(start.toString());
    } else {
        ranges.push(`${start}-${end}`);
    }
    
    return ranges.join(',');
}

// 计算集数
function countEpisodes(episodes) {
    if (!episodes) return 0;
    
    if (typeof episodes === 'string') {
        return episodes.split(',').length;
    } else if (typeof episodes === 'number') {
        return 1; // 如果是数字，表示这是一个集号而不是集数
    }
    
    return 0;
}

async function createMediaCard(media, type, imageBaseUrl, apiKey) {
    const card = document.createElement('div');
    card.className = 'media-card';
    card.dataset.id = media.id;
    card.dataset.type = type;
    card.dataset.tmdbId = media.tmdb_id;
    
    // 默认海报
    const defaultPosterUrl = '/static/img/no-image.png';
    let posterUrl = defaultPosterUrl;
    
    // 构建季集信息（仅在电视节目时显示）
    let seasonsInfo = '';
    if (type === 'tv' && media.seasons) {
        const seasonsCount = media.seasons.length;
        let totalEpisodes = 0;
        
        // 计算总集数
        media.seasons.forEach(season => {
            totalEpisodes += countEpisodes(season.episodes);
        });
        
        seasonsInfo = `共 ${seasonsCount} 季 | 共 ${totalEpisodes} 集`;
    }
    
    card.innerHTML = `
        <img class="media-poster" src="${posterUrl}" 
             data-src="${posterUrl}" 
             data-tmdb-id="${media.tmdb_id || ''}" 
             data-type="${type}" 
             data-api-key="${apiKey}" 
             alt="${media.title}">
        <div class="media-info">
            <div class="media-title">${media.title}</div>
            <div class="media-year">${media.year || '未知年份'}</div>
            ${type === 'tv' ? `<div class="seasons-info">${seasonsInfo}</div>` : ''}
        </div>
    `;
    
    // 添加点击事件
    card.addEventListener('click', () => showMediaDetails(media, type, imageBaseUrl, apiKey));
    
    // 如果有tmdb_id，尝试获取真实海报
    if (media.tmdb_id) {
        // 延迟加载海报，避免阻塞UI
        setTimeout(() => {
            loadPosterImage(card.querySelector('.media-poster'), media.tmdb_id, type, imageBaseUrl, apiKey);
        }, 10);
    }
    
    return card;
}

// 异步加载海报图片
async function loadPosterImage(imgElement, tmdbId, type, imageBaseUrl, apiKey) {
    try {
        const response = await fetch(`https://api.tmdb.org/3/${type}/${tmdbId}?api_key=${apiKey}&language=zh-CN`);
        if (response.ok) {
            const details = await response.json();
            if (details.poster_path) {
                const posterUrl = `${imageBaseUrl}${details.poster_path}`;
                
                // 创建新的图片元素来预加载
                const tempImage = new Image();
                tempImage.onload = function() {
                    // 图片加载成功后，替换默认图片
                    imgElement.src = posterUrl;
                };
                tempImage.onerror = function() {
                    // 图片加载失败，保持默认图片
                    console.warn('海报图片加载失败，使用默认图片');
                };
                tempImage.src = posterUrl;
            }
        }
    } catch (error) {
        console.error('获取海报信息失败:', error);
        // 保持默认图片
    }
}

// 获取导演信息
function getDirectors(crew) {
    return crew.filter(person => person.job === "Director");
}

// 获取主要演员信息
function getMainCast(cast, limit = 6) {
    // 按照知名度排序并取前几个
    return cast
        .sort((a, b) => b.popularity - a.popularity)
        .slice(0, limit);
}

// 创建演员/导演头像元素
function createPersonElement(person, imageBaseUrl, isDirector = false) {
    const personDiv = document.createElement('div');
    personDiv.className = 'person-card';
    
    // 处理过长的名字
    const maxNameLength = 8;
    const displayName = person.name.length > maxNameLength ? 
        person.name.substring(0, maxNameLength) + '...' : person.name;
        
    const roleName = isDirector ? '导演' : (person.character || '演员');
    const displayRole = roleName.length > 8 ? 
        roleName.substring(0, 8) + '...' : roleName;
    
    const profileUrl = person.profile_path 
        ? `${imageBaseUrl}${person.profile_path}` 
        : '/static/img/avatar.png';
    
    personDiv.innerHTML = `
        <div class="person-image">
            <img src="${profileUrl}" alt="${person.name}" onerror="this.src='/static/img/avatar.png'">
        </div>
        <div class="person-info">
            <div class="person-name" title="${person.name}">${displayName}</div>
            <div class="person-role" title="${roleName}">${displayRole}</div>
        </div>
    `;
    
    return personDiv;
}

async function showMediaDetails(media, type, imageBaseUrl, apiKey) {
    try {
        // 获取TMDB详细信息
        const response = await fetch(`https://api.tmdb.org/3/${type}/${media.tmdb_id}?api_key=${apiKey}&language=zh-CN&append_to_response=credits`);
        const details = await response.json();
        
        // 填充模态框内容
        document.getElementById('modal-poster-img').src = details.poster_path 
            ? `${imageBaseUrl}${details.poster_path}` 
            : '/static/img/no-image.png';
        document.getElementById('modal-title').textContent = details.title || details.name;
        document.getElementById('modal-year').textContent = details.release_date 
            ? new Date(details.release_date).getFullYear() 
            : details.first_air_date 
                ? new Date(details.first_air_date).getFullYear() 
                : '未知年份';
        
        // 类型信息
        const genres = details.genres ? details.genres.map(g => g.name).join(', ') : '未知类型';
        document.getElementById('modal-genres').textContent = `类型: ${genres}`;
        
        // 评分信息
        const rating = details.vote_average ? details.vote_average.toFixed(1) : '暂无评分';
        document.getElementById('modal-rating').textContent = `评分: ${rating}`;
        
        // 季集信息（仅电视剧）
        const seasonsContainer = document.getElementById('modal-seasons');
        if (type === 'tv' && media.seasons) {
            let seasonsHtml = '<strong>季集信息:</strong><br>';
            media.seasons.forEach(season => {
                let episodeInfo = '';
                let missingInfo = '';
                
                if (season.episodes) {
                    if (typeof season.episodes === 'string') {
                        episodeInfo = formatEpisodeRanges(season.episodes);
                        
                        // 计算并显示缺失的集数
                        const missingEpisodes = findMissingEpisodes(season.episodes);
                        if (missingEpisodes.length > 0) {
                            const formattedMissing = formatMissingEpisodes(missingEpisodes);
                            missingInfo = ` (缺失: ${formattedMissing})`;
                        }
                    } else if (typeof season.episodes === 'number') {
                        episodeInfo = season.episodes.toString(); // 直接显示集号
                    }
                }
                seasonsHtml += `第 ${season.season} 季: 第 ${episodeInfo} 集${missingInfo}<br>`;
            });
            seasonsContainer.innerHTML = seasonsHtml;
            seasonsContainer.style.display = 'block';
        } else {
            seasonsContainer.style.display = 'none';
        }
        
        // 简介
        document.getElementById('modal-overview').textContent = details.overview || '暂无简介';
        
        // 演员和导演信息
        const creditsContainer = document.createElement('div');
        creditsContainer.className = 'modal-credits mt-3';
        
        if (details.credits) {
            // 导演信息
            const directors = getDirectors(details.credits.crew);
            if (directors.length > 0) {
                const directorsSection = document.createElement('div');
                directorsSection.className = 'credits-section';
                directorsSection.innerHTML = '<h5>导演</h5>';
                const directorsList = document.createElement('div');
                directorsList.className = 'persons-list';
                
                directors.forEach(director => {
                    const directorElement = createPersonElement(director, imageBaseUrl, true);
                    directorsList.appendChild(directorElement);
                });
                
                directorsSection.appendChild(directorsList);
                creditsContainer.appendChild(directorsSection);
            }
            
            // 主要演员信息
            const mainCast = getMainCast(details.credits.cast);
            if (mainCast.length > 0) {
                const castSection = document.createElement('div');
                castSection.className = 'credits-section mt-3';
                castSection.innerHTML = '<h5>主要演员</h5>';
                const castList = document.createElement('div');
                castList.className = 'persons-list';
                
                mainCast.forEach(person => {
                    const personElement = createPersonElement(person, imageBaseUrl);
                    castList.appendChild(personElement);
                });
                
                castSection.appendChild(castList);
                creditsContainer.appendChild(castSection);
            }
            
            // 添加到模态框中（在简介之后）
            const overviewSection = document.querySelector('.modal-overview');
            // 清除之前可能添加的内容
            const existingCredits = document.querySelector('.modal-credits');
            if (existingCredits) {
                existingCredits.remove();
            }
            overviewSection.parentNode.insertBefore(creditsContainer, overviewSection.nextSibling);
        }
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('mediaModal'));
        modal.show();
    } catch (error) {
        console.error('获取媒体详情出错:', error);
        showToast('获取媒体详情失败', 'error');
    }
}
</script>
{% endblock %}