{% extends "base.html" %}
{% block title %}热门推荐{% endblock %}
{% block content %}
    <style>
        /* 全局样式 */
        body {
            padding: 0;
        }

        h1, h2 {
            text-align: center;
            margin: 20px 0;
            color: #333333; /* 深灰色标题 */
            text-shadow: none; /* 移除阴影 */
        }

        section {
            max-width: 1200px;
            padding: 0 20px;
        }

        /* Banner 样式 */
        .banner {
            position: relative;
            width: 100%;
            height: 400px; /* 固定高度 */
            margin-top: 40px;
            overflow: hidden;
            margin-bottom: 10px;
            border-radius: 10px; /* 圆角效果 */
        }

        .banner-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover; /* 保持纵横比缩放填充 */
            background-position: center top; /* 水平居中，顶部对齐 */
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            flex-direction: column; /* 垂直排列内容 */
            justify-content: flex-end; /* 内容对齐到底部 */
            color: white; /* 白色字体 */
            padding: 20px; /* 底部内边距 */
            box-sizing: border-box;
        }

        .banner-item.active {
            opacity: 1;
        }

        .banner-item .textcontent {
            max-width: 100%;
            padding: 10px 20px; /* 内容区域内边距 */
            border-radius: 5px; /* 圆角效果 */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); /* 半透明灰色阴影 */
        }

        .banner-item p.title {
            font-size: 24px;
            font-weight: bold;
            margin: 0 0 5px 0; /* 减小间距 */
        }

        .banner-item p.overview {
            font-size: 14px;
            margin: 0;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3; /* 限制显示的行数 */
            line-clamp: 3; /* 标准属性 */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 进度条容器样式 */
        .progress-bar-container {
            position: absolute;
            bottom: 0; /* 固定在容器底部 */
            left: 0;
            width: 100%;
            height: 3px; /* 进度条高度 */
            background: rgba(255, 255, 255, 0.3); /* 半透明背景 */
            overflow: hidden;
            border-radius: 3px; /* 圆角效果 */
        }
        
        /* 进度条样式 */
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: #adb5bd; /* 进度条颜色 */
            transition: width 0.3s linear; /* 平滑过渡效果 */
        }

        /* Carousel 容器样式 */
        .carousel-container {
            position: relative;
            overflow: hidden;
            white-space: nowrap; /* 防止内容换行 */
        }

        /* 滚动列表样式 */
        .movie-list, .tv-list {
            white-space: nowrap;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 8px; /* 内边距 */
        }

        /* 隐藏滚动条 */
        .movie-list::-webkit-scrollbar, .tv-list::-webkit-scrollbar {
            display: none;
        }

        /* 箭头按钮样式 */
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(0, 0, 0, 0.5);
            border: none;
            font-size: 30px;
            cursor: pointer;
            z-index: 10;
        }

        .carousel-arrow.prev {
            left: 0px;
            width: 40px; 
            height: 100%;
            background: linear-gradient(to right, #f9f9f9, rgba(249, 249, 249, 0)); /* 从浅灰色到透明 */
        }
        
        .carousel-arrow.next {
            right: 0px;
            width: 40px;
            height: 100%;
            background: linear-gradient(to left, #f9f9f9, rgba(249, 249, 249, 0)); /* 从浅灰色到透明 */
        }
        
        .carousel-arrow:hover {
            font-size: 35px;
        }

        /* 推荐列表样式 */
        .movie-item, .tv-item {
            display: inline-block; /* 确保水平排列 */
            position: relative; /* 为评分和标题定位 */
            width: 150px; /* 固定宽度 */
            height: 225px; /* 固定高度 */
            margin-right: 20px; /* 项目之间的间距 */
            border-radius: 10px; /* 圆角效果 */
            overflow: hidden; /* 隐藏溢出内容 */
            background: #f0f0f0; /* 默认背景色 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 浅色阴影 */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
    
        .movie-item:hover, .tv-item:hover {
            transform: scale(1.05); /* 鼠标悬停放大效果 */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2); /* 稍深的阴影 */
        }
    
        .movie-item img, .tv-item img {
            width: 100%; /* 图片宽度填充容器 */
            height: 100%; /* 图片高度填充容器 */
            object-fit: cover; /* 保持图片比例裁剪 */
        }
    
        /* 评分显示在左上角 */
        .movie-item .rating, .tv-item .rating, .banner-item .rating {
            position: absolute;
            top: 5px;
            left: 5px; /* 左上角 */
            background: rgba(0, 0, 0, 0.7); /* 半透明黑色背景 */
            color: #fff; /* 白色文字 */
            font-size: 14px;
            border-radius: 5px; /* 圆角效果 */
            display: block;
        }
    
        /* 标题样式 */
        .movie-item .title, .tv-item .title {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7); /* 半透明黑灰色背景 */
            color: #fff; /* 白色文字 */
            font-size: 14px;
            text-align: center;
            padding: 5px 0;
            box-sizing: border-box;
        }

        button.bi.bi-bookmark-star-fill {
            color: #495057;
            border: none;
            margin: 5px 0;
            font-size: 0.8em;
            padding-left: 0;
            background-color: unset;
        }

        button.bi.bi-search {
            color: rgb(25, 135, 84);
            border: none;
            margin: 5px 0;
            font-size: 0.8em;
            padding-left: 0;
            background-color: unset;
        }

        .search {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 0 auto;
            display: flex;
            justify-content: center;
        }
        .search form {
            width: 100%;
            display: flex;
            gap: 10px;
        }
        .inner_search_wrapper {
            flex: 1;
        }
        .k-input-inner {
            width: 100%;
            padding: 8px 12px;
            border-radius: 30px;
            border: 1px solid transparent;
            font-size: 16px;
            background-origin: border-box;
            background-clip: padding-box, border-box;
            background-image: linear-gradient(#fff, #fff), linear-gradient(to right,rgba(30,213,169,1) 0%,rgba(1,180,228,1) 100%);
            /* 第一层白色，第二层为渐变边框 */
        }
        /* 保持输入时边框颜色不变 */
        .k-input-inner:focus {
            border-color: rgba(1,180,228,1);
            outline: none;
        }
        .k-button {
            padding: 8px 20px;
            border-radius: 30px;
            background: linear-gradient(to right,rgba(30,213,169,1) 0%,rgba(1,180,228,1) 100%);
            color: #fff;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        .k-button:hover {
            color: rgba(3,37,65);
        }
        .search-results-section {
            margin-top: 30px;
        }
        .search-list {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px 20px;
            padding: 8px;
            overflow-x: auto;
            overflow-y: visible;
            scroll-behavior: smooth;
        }
        .search-list::-webkit-scrollbar {
            display: none;
        }
        .search-item {
            display: inline-block;
            position: relative;
            width: 150px;
            height: 225px;
            margin-right: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #f0f0f0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            vertical-align: top;
        }
        .search-item:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 10px rgba(0,0,0,0.2);
        }
        .search-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .search-item .rating {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 14px;
            border-radius: 5px;
            display: block;
            padding: 2px 6px;
        }
        .search-item .title {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 14px;
            text-align: center;
            padding: 5px 0;
            box-sizing: border-box;
        }
        @media (max-width: 1200px) {
            .search-list {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (max-width: 768px) {
            .search-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .movie-item, .tv-item {
                width: 150px; /* 在小屏幕上适当缩小宽度 */
            }

            .banner {
                height: 300px; /* 减小高度 */
            }

            .banner-item {
                padding: 10px; /* 减小内边距 */
            }

            .banner-item p.title {
                font-size: 20px; /* 减小标题字体 */
            }

            .banner-item p.overview {
                font-size: 14px; /* 减小简介字体 */
            }
            .modal-header {
                flex-direction: column;
            }
        }

        /* 加载动画 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9); /* 浅色背景 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading span {
            font-size: 24px;
            color: #333333; /* 深灰色文字 */
            animation: blink 1s infinite;
        }

        .api-error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 50px 20px;
            color: #dc3545;
            font-size: clamp(12px, 1.2vw, 16px);
            font-weight: bold;
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.9);
            z-index: 20;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 季选择模态框样式 */
        .season-selection {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .season-selection .form-check {
            margin-top: 10px;
            margin-left: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .season-selection .form-check:last-child {
            border-bottom: none;
        }
        
        .season-selection .form-check-input {
            margin-top: 2px;
        }

    </style>
<main class="container mt-4">
    <div class="row fade-in">
        <!-- 加载动画 -->
        <div class="loading" id="loading">
            <span>加载中...</span>
        </div>

        <!-- API Key 无效提示 -->
        <div id="api-error-message" class="api-error" style="display: none;">
            无法获取热门推荐<br>TMDB API KEY 无效或无法获取TMDB数据<br>请检查系统设置TMDB API密钥及本地网络与api.tmdb.org的网络连通性！
        </div>

        <!-- 主要内容区域 -->
        <div id="main-content">
            <div id="banner" class="banner">
                <div class="banner-list">
                    <!-- 随机推荐内容将在这里填充 -->
                </div>
            </div>

            <!-- 搜索框 -->
            <div class="search">
                <form id="inner_search_form" action="javascript:void(0);" method="get" accept-charset="utf-8">
                    <label class="inner_search_wrapper">
                        <span class="k-input k-textbox k-input-solid k-input-md k-rounded-md">
                            <input dir="auto" id="inner_search_v4" name="query" type="text" autocorrect="off" autofill="off" autocomplete="off" spellcheck="false" placeholder="搜索电影、电视节目" value="" data-role="textbox" aria-disabled="false" class="k-input-inner" inputmode="text">
                        </span>
                    </label>
                    <input type="submit" value="搜索" data-role="button" class="k-button k-button-md k-rounded-md k-button-solid k-button-solid-base" role="button" aria-disabled="false" tabindex="0">
                </form>
            </div>

            <!-- 搜索结果区域 -->
            <section id="search-results-section" class="search-results-section" style="display:none;">
                <h2>搜索结果</h2>
                <div class="search-results-carousel-container">
                    <div class="search-list" id="search-results-list"></div>
                </div>
            </section>

            <section id="top-rated">
                <h2>高分佳作</h2>
                <div class="carousel-container">
                    <button class="carousel-arrow prev" onclick="scrollCarousel('top-rated-list', -1)">&#10094;</button>
                    <div class="movie-list" id="top-rated-list"></div>
                    <button class="carousel-arrow next" onclick="scrollCarousel('top-rated-list', 1)">&#10095;</button>
                </div>
            </section>

            <section id="now-playing">
                <h2>院线热映</h2>
                <div class="carousel-container">
                    <button class="carousel-arrow prev" onclick="scrollCarousel('now-playing-list', -1)">&#10094;</button>
                    <div class="movie-list" id="now-playing-list"></div>
                    <button class="carousel-arrow next" onclick="scrollCarousel('now-playing-list', 1)">&#10095;</button>
                </div>
            </section>

            <section id="china-movies">
                <h2>国产新片</h2>
                <div class="carousel-container">
                    <button class="carousel-arrow prev" onclick="scrollCarousel('china-movies-list', -1)">&#10094;</button>
                    <div class="movie-list" id="china-movies-list"></div>
                    <button class="carousel-arrow next" onclick="scrollCarousel('china-movies-list', 1)">&#10095;</button>
                </div>
            </section>

            <section id="china-tv-shows">
                <h2>国产新剧</h2>
                <div class="carousel-container">
                    <button class="carousel-arrow prev" onclick="scrollCarousel('china-tv-shows-list', -1)">&#10094;</button>
                    <div class="tv-list" id="china-tv-shows-list"></div>
                    <button class="carousel-arrow next" onclick="scrollCarousel('china-tv-shows-list', 1)">&#10095;</button>
                </div>
            </section>

            <section id="today-movies">
                <h2>热门电影</h2>
                <div class="carousel-container">
                    <button class="carousel-arrow prev" onclick="scrollCarousel('today-movies-list', -1)">&#10094;</button>
                    <div class="movie-list" id="today-movies-list"></div>
                    <button class="carousel-arrow next" onclick="scrollCarousel('today-movies-list', 1)">&#10095;</button>
                </div>
            </section>

            <section id="today-tv-shows">
                <h2>热播剧集</h2>
                <div class="carousel-container">
                    <button class="carousel-arrow prev" onclick="scrollCarousel('today-tv-shows-list', -1)">&#10094;</button>
                    <div class="tv-list" id="today-tv-shows-list"></div>
                    <button class="carousel-arrow next" onclick="scrollCarousel('today-tv-shows-list', 1)">&#10095;</button>
                </div>
            </section>
        
        <!-- Modal -->
        <div id="mediaDetailsModal" class="modal fade" tabindex="-1" aria-labelledby="InfoCardLabel">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="InfoCard-header d-flex justify-content-between align-items-center">
                        <h5 class="InfoCard-title" id="InfoCardLabel">影片简介</h5>
                        <button type="button" class="btn-close text-reset" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-header">
                            <div class="modal-poster">
                                <img id="modalPoster" src="" alt="海报"> <!-- 海报图 -->
                            </div>
                            <div class="modal-details">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h3 id="modalTitle" class="me-3"></h3> <!-- 标题 -->
                                </div>
                                <!-- 按钮位置调整 -->
                                <div class="d-flex">
                                    <button type="button" class="bi bi-bookmark-star-fill me-2" id="subscribeButton">订阅</button>
                                    <button type="button" class="bi bi-search" id="searchResourceButton">资源搜索</button>
                                </div>
                                <p id="modalRating" class="text-muted"></p> <!-- 评分 -->
                                <p id="modalSeasons" style="display: none;"></p> <!-- 季数 -->
                                <p id="modalEpisodeCount" style="display: none;"></p> <!-- 集数 -->
                                <p id="modalYear"></p> <!-- 发行年份 -->
                                <p id="modalOverview"></p> <!-- 剧情简介 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // 获取从后端传递的 tmdb_api_key
    const tmdbApiKey = "{{ tmdb_api_key }}";

    // 显示加载动画
    const loadingElement = document.getElementById('loading');
    const apiErrorMessage = document.getElementById('api-error-message');
    const mainContent = document.getElementById('main-content');

    function hideLoading() {
        loadingElement.style.display = 'none';
    }

    function showApiError() {
        apiErrorMessage.style.display = 'block';
        mainContent.style.display = 'none'; // 隐藏原有元素
        hideLoading();
    }

    // 搜索功能
    document.getElementById('inner_search_form').addEventListener('submit', function (e) {
        e.preventDefault();
        const query = document.getElementById('inner_search_v4').value.trim();
        if (!query) return;
        // 隐藏推荐区
        document.getElementById('now-playing').style.display = 'none';
        document.getElementById('today-movies').style.display = 'none';
        document.getElementById('today-tv-shows').style.display = 'none';
        document.getElementById('china-movies').style.display = 'none';
        document.getElementById('china-tv-shows').style.display = 'none';
        document.getElementById('top-rated').style.display = 'none';
        // 显示搜索结果区
        document.getElementById('search-results-section').style.display = '';
        // 显示加载动画
        loadingElement.style.display = '';
        // 搜索 TMDB
        fetch(`https://api.tmdb.org/3/search/multi?api_key=${tmdbApiKey}&language=zh-CN&query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                displaySearchResults(data.results || []);
            })
            .catch(error => {
                hideLoading();
                displaySearchResults([]);
                showToast('搜索失败，请稍后重试。', false);
            });
    });

    // 搜索结果展示
    function displaySearchResults(results) {
        const listElement = document.getElementById('search-results-list');
        listElement.innerHTML = '';
        if (!results.length) {
            listElement.innerHTML = '<div style="color:#888;padding:20px;">未找到相关内容</div>';
            return;
        }
        results.forEach(item => {
            // 只展示电影和电视剧
            if (item.media_type !== 'movie' && item.media_type !== 'tv') return;
            const listItem = document.createElement('div');
            listItem.className = 'search-item';
            // 海报
            const posterElement = document.createElement('img');
            posterElement.src = '/static/img/no-image.png'; // 优先显示默认图片

            // 优先显示默认图片，加载成功后再显示 TMDB 图片
            if (item.poster_path) {
                const tmdbPosterUrl = `https://image.tmdb.org/t/p/w500${item.poster_path}`;
                const imgLoader = new Image();
                imgLoader.onload = function() {
                    posterElement.src = tmdbPosterUrl;
                };
                imgLoader.onerror = function() {
                    posterElement.src = '/static/img/no-image.png';
                };
                imgLoader.src = tmdbPosterUrl;
            }
            posterElement.alt = item.title || item.name || '无标题';
            // 评分
            const ratingElement = document.createElement('div');
            ratingElement.className = 'rating';
            ratingElement.textContent = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
            // 标题
            const titleElement = document.createElement('div');
            titleElement.className = 'title';
            titleElement.textContent = item.title || item.name || '无标题';
            // 点击弹出模态框
            listItem.addEventListener('click', () => {
                showMovieDetails(item.id, item.media_type);
            });
            listItem.appendChild(posterElement);
            listItem.appendChild(ratingElement);
            listItem.appendChild(titleElement);
            listElement.appendChild(listItem);
        });
    }

    // 恢复推荐区显示
    function showRecommendations() {
        document.getElementById('now-playing').style.display = '';
        document.getElementById('today-movies').style.display = '';
        document.getElementById('today-tv-shows').style.display = '';
        document.getElementById('china-movies').style.display = '';
        document.getElementById('china-tv-shows').style.display = '';
        document.getElementById('top-rated').style.display = '';
        document.getElementById('search-results-section').style.display = 'none';
    }

    // 监听搜索框清空时恢复推荐区
    document.getElementById('inner_search_v4').addEventListener('input', function () {
        if (!this.value.trim()) {
            showRecommendations();
        }
    });

    // 使用API Key获取电影热门推荐
    function fetchTrendingMovies(apiKey) {
        const url = `https://api.tmdb.org/3/trending/movie/day?api_key=${apiKey}&language=zh-CN`;

        return fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('电影热门推荐数据:', data.results); // 添加日志
                displayRecommendations(data.results, 'today-movies-list');
                return data.results;
            })
            .catch(error => {
                console.error('获取电影热门推荐时出错:', error);
                return []; // 返回空数组以避免 undefined
            });
    }

    // 使用API Key获取影院热映推荐（国内外电影综合显示）
    function fetchNowPlayingMovies(apiKey) {
        // 获取全球正在上映的电影
        const globalUrl = `https://api.tmdb.org/3/movie/now_playing?api_key=${apiKey}&language=zh-CN&page=1`;
        // 获取中国地区正在上映的电影
        const chinaUrl = `https://api.tmdb.org/3/movie/now_playing?api_key=${apiKey}&language=zh-CN&region=CN&page=1`;
        
        // 并行获取全球和中国地区的热映电影
        return Promise.all([
            fetch(globalUrl).then(response => response.json()),
            fetch(chinaUrl).then(response => response.json())
        ])
        .then(([globalData, chinaData]) => {
            // 分别从国内和全球电影中随机选择10部
            const seenIds = new Set();
            const combinedResults = [];
            
            // 从中国电影中随机选择10部（如果不足10部则选择所有）
            const chinaMovies = chinaData.results
                .filter(movie => movie.poster_path) // 确保有海报
                .sort(() => 0.5 - Math.random()) // 随机排序
                .slice(0, 10); // 取前10部
            
            // 添加中国电影并记录ID
            chinaMovies.forEach(movie => {
                if (!seenIds.has(movie.id)) {
                    seenIds.add(movie.id);
                    combinedResults.push(movie);
                }
            });
            
            // 从全球电影中随机选择10部（如果不足10部则选择所有）
            // 需要排除已经添加的中国电影
            const globalMovies = globalData.results
                .filter(movie => movie.poster_path && !seenIds.has(movie.id)) // 有海报且未重复
                .sort(() => 0.5 - Math.random()) // 随机排序
                .slice(0, 10); // 取前10部
            
            // 添加全球电影
            globalMovies.forEach(movie => {
                if (!seenIds.has(movie.id)) {
                    seenIds.add(movie.id);
                    combinedResults.push(movie);
                }
            });
            
            // 如果总数不足20部，从全球电影中补充
            if (combinedResults.length < 20) {
                const additionalMovies = globalData.results
                    .filter(movie => movie.poster_path && !seenIds.has(movie.id)) // 有海报且未重复
                    .sort(() => 0.5 - Math.random()) // 随机排序
                    .slice(0, 20 - combinedResults.length); // 补足到20部
                
                additionalMovies.forEach(movie => {
                    combinedResults.push(movie);
                });
            }
            
            // 最终随机排序，避免国内和国际影片扎堆出现
            const shuffledResults = combinedResults
                .map(item => ({ item, sort: Math.random() }))
                .sort((a, b) => a.sort - b.sort)
                .map(({ item }) => item);
            
            console.log('影院热映推荐数据（国内外综合）:', shuffledResults);
            displayRecommendations(shuffledResults, 'now-playing-list');
            return shuffledResults;
        })
        .catch(error => {
            console.error('获取影院热映推荐时出错:', error);
            // 出错时回退到原始方法
            return fetch(`https://api.tmdb.org/3/movie/now_playing?api_key=${apiKey}&language=zh-CN`)
                .then(response => response.json())
                .then(data => {
                    console.log('影院热映推荐数据（回退方案）:', data.results);
                    const filteredResults = data.results.filter(movie => 
                        movie.poster_path && movie.vote_average > 0
                    ).slice(0, 20);
                    // 随机排序回退结果
                    const shuffledResults = filteredResults
                        .map(item => ({ item, sort: Math.random() }))
                        .sort((a, b) => a.sort - b.sort)
                        .map(({ item }) => item);
                    displayRecommendations(shuffledResults, 'now-playing-list');
                    return shuffledResults;
                })
                .catch(fallbackError => {
                    console.error('获取影院热映推荐回退方案也失败:', fallbackError);
                    return [];
                });
        });
    }

    // 使用API Key获取热门剧集推荐
    function fetchTrendingTVShows(apiKey) {
        const url = `https://api.tmdb.org/3/trending/tv/day?api_key=${apiKey}&language=zh-CN`;

        return fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('热门剧集推荐数据:', data.results); // 添加日志
                displayRecommendations(data.results, 'today-tv-shows-list');
                return data.results;
            })
            .catch(error => {
                console.error('获取热门剧集推荐时出错:', error);
                return []; // 返回空数组以避免 undefined
            });
    }

    // 获取国内最新电影
    function fetchChinaMovies(apiKey) {
        // 使用 Discover API 并设置地区为中国 (CN)
        // 添加更多筛选条件：
        // 1. 限定发布日期范围为最近1年
        // 2. 要求有评分和投票数
        // 3. 限定语言为中文或英语（避免纯地区筛选问题）
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date();
        startDate.setFullYear(startDate.getFullYear() - 1);
        const startDateStr = startDate.toISOString().split('T')[0];
        
        const url = `https://api.tmdb.org/3/discover/movie?api_key=${apiKey}&language=zh-CN&sort_by=release_date.desc&primary_release_date.gte=${startDateStr}&primary_release_date.lte=${endDate}&with_origin_country=CN&vote_count.gte=10`;
        
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('国内最新电影数据:', data.results);
                // 过滤掉没有海报或评分过低的电影
                const filteredResults = data.results.filter(movie => 
                    movie.poster_path && 
                    movie.vote_average > 0 && 
                    movie.vote_count > 0 &&
                    movie.release_date &&
                    movie.release_date <= endDate
                ).slice(0, 20); // 只取前20个结果
                displayRecommendations(filteredResults, 'china-movies-list');
                return filteredResults;
            })
            .catch(error => {
                console.error('获取国内最新电影时出错:', error);
                return [];
            });
    }

    // 获取中国国内最新剧集（包括正在播出和完结的剧集）
    function fetchChinaTVShows(apiKey) {
        // 使用 Discover API 并设置更多筛选条件
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 6);
        const startDateStr = startDate.toISOString().split('T')[0];
        
        // 添加更多筛选条件：
        // 1. 限定首播日期范围为最近3个月
        // 2. 要求有评分和投票数
        // 3. 限定原始语言为中文
        // 4. 可以添加 with_origin_country=CN 或使用 region=CN
        const url = `https://api.tmdb.org/3/discover/tv?api_key=${apiKey}&language=zh-CN&sort_by=first_air_date.desc&first_air_date.gte=${startDateStr}&first_air_date.lte=${endDate}&with_original_language=zh&vote_count.gte=1&vote_average=4&page=1`;
        
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('国内最新剧集数据:', data.results);
                // 过滤掉没有海报或评分过低的剧集
                const filteredResults = data.results.filter(show => 
                    show.poster_path && 
                    show.vote_average > 0 && 
                    show.vote_count > 0 &&
                    show.first_air_date &&
                    show.first_air_date <= endDate
                ).slice(0, 20); // 只取前20个结果
                displayRecommendations(filteredResults, 'china-tv-shows-list');
                return filteredResults;
            })
            .catch(error => {
                console.error('获取国内最新剧集时出错:', error);
                return [];
            });
    }

    // 获取高分推荐 (电影和电视剧综合)
    function fetchTopRated(apiKey) {
        // 先获取高分电影
        const movieUrl = `https://api.tmdb.org/3/movie/top_rated?api_key=${apiKey}&language=zh-CN`;
        
        return fetch(movieUrl)
            .then(response => response.json())
            .then(data => {
                // 从高分电影中随机取10个
                const shuffledMovies = data.results.sort(() => 0.5 - Math.random());
                const topMovies = shuffledMovies.slice(0, 10);
                
                // 再获取高分电视剧
                const tvUrl = `https://api.tmdb.org/3/tv/top_rated?api_key=${apiKey}&language=zh-CN`;
                return fetch(tvUrl)
                    .then(response => response.json())
                    .then(tvData => {
                        // 从高分电视剧中随机取10个
                        const shuffledTVShows = tvData.results.sort(() => 0.5 - Math.random());
                        const topTVShows = shuffledTVShows.slice(0, 10);
                        
                        // 合并电影和电视剧并随机排序
                        const allTopRated = [...topMovies, ...topTVShows]
                            .sort(() => 0.5 - Math.random()) // 随机排序
                            .slice(0, 20); // 取前20个
                        
                        console.log('高分推荐数据:', allTopRated);
                        displayRecommendations(allTopRated, 'top-rated-list');
                        return allTopRated;
                    });
            })
            .catch(error => {
                console.error('获取高分推荐时出错:', error);
                return [];
            });
    }

    // 显示推荐资源
    function displayRecommendations(recommendations, listId) {
        const listElement = document.getElementById(listId);
        listElement.innerHTML = ''; // 清空原有内容

        recommendations.forEach(item => {
            if (item) {
                const listItem = document.createElement('div');
                listItem.className = listId.includes('tv') ? 'tv-item' : 'movie-item';

                // 海报图片，优先显示默认图片，加载成功后再显示 TMDB 图
                const posterElement = document.createElement('img');
                posterElement.src = '/static/img/no-image.png';
                if (item.poster_path) {
                    const tmdbPosterUrl = `https://image.tmdb.org/t/p/w500${item.poster_path}`;
                    const imgLoader = new Image();
                    imgLoader.onload = function() {
                        posterElement.src = tmdbPosterUrl;
                    };
                    imgLoader.onerror = function() {
                        posterElement.src = '/static/img/no-image.png';
                    };
                    imgLoader.src = tmdbPosterUrl;
                }
                posterElement.alt = item.title || item.name || '无标题';

                // 添加点击事件，显示模态框
                // 修复：正确识别媒体类型，电影使用movie，电视剧使用tv
                const mediaType = item.media_type || (item.first_air_date ? 'tv' : 'movie');
                posterElement.addEventListener('click', () => {
                    showMovieDetails(item.id, mediaType);
                });

                // 评分
                const ratingElement = document.createElement('div');
                ratingElement.className = 'rating';
                ratingElement.textContent = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';

                // 标题
                const titleElement = document.createElement('div');
                titleElement.className = 'title';
                titleElement.textContent = item.title || item.name || '无标题';

                // 组装元素
                listItem.appendChild(posterElement);
                listItem.appendChild(ratingElement);
                listItem.appendChild(titleElement);
                listElement.appendChild(listItem);
            }
        });

        // 添加占位内容以确保滚动
        if (recommendations.length < 10) {
            for (let i = 0; i < 10 - recommendations.length; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'movie-item';
                placeholder.textContent = '占位内容';
                listElement.appendChild(placeholder);
            }
        }
    }

    // 获取影片详细信息
    function fetchMovieDetails(tmdbId, mediaType, apiKey) {
        // 根据 mediaType 动态选择请求路径
        const url = `https://api.tmdb.org/3/${mediaType}/${tmdbId}?api_key=${apiKey}&language=zh-CN`;

        return fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('影片详细信息:', data); // 添加日志
                return data;
            })
            .catch(error => {
                console.error('获取影片详细信息时出错:', error);
                return null;
            });
    }

    // Banner推荐区，优先显示默认banner，加载成功后再显示TMDB图片
    function populateBanner(trendingMovies, nowPlayingMovies, trendingTVShows, chinaMovies, chinaTVShows, topRated) {
        const bannerListElement = document.querySelector('.banner-list');
        const bannerElement = document.getElementById('banner');
        bannerListElement.innerHTML = ''; // 清空原有内容

        // 从每个分类中随机选择两个推荐项
        const getRandomItems = (array, count) => {
            const shuffled = array.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        };

        const selectedTrendingMovies = getRandomItems(trendingMovies, 2);
        const selectedNowPlaying = getRandomItems(nowPlayingMovies, 2);
        const selectedTrendingTVShows = getRandomItems(trendingTVShows, 2);
        const selectedChinaMovies = getRandomItems(chinaMovies, 2);
        const selectedChinaTVShows = getRandomItems(chinaTVShows, 2);
        const selectedTopRated = getRandomItems(topRated, 2);

        // 合并所有推荐项
        const allRecommendations = [
            ...selectedTrendingMovies, 
            ...selectedNowPlaying, 
            ...selectedTrendingTVShows,
            ...selectedChinaMovies,
            ...selectedChinaTVShows,
            ...selectedTopRated
        ];

        // 去重逻辑：使用 tmdbId 或 title 作为唯一标识
        const uniqueRecommendations = [];
        const seenIds = new Set();

        allRecommendations.forEach(item => {
            const uniqueKey = item.id || item.title; // 使用 tmdbId 或 title 作为唯一标识
            if (!seenIds.has(uniqueKey)) {
                seenIds.add(uniqueKey);
                uniqueRecommendations.push(item);
            }
        });

        // 确保最终有12个推荐项（如果去重后不足12个，则从原数据中补充）
        let selectedRecommendations = uniqueRecommendations.slice(0, 12);
        
        // 如果去重后不足12个，从所有分类中补充
        if (selectedRecommendations.length < 12) {
            const allItems = [
                ...trendingMovies, 
                ...nowPlayingMovies, 
                ...trendingTVShows,
                ...chinaMovies,
                ...chinaTVShows,
                ...topRated
            ];
            
            // 补充不足的部分
            for (let i = 0; i < allItems.length && selectedRecommendations.length < 12; i++) {
                const item = allItems[i];
                const uniqueKey = item.id || item.title;
                if (!seenIds.has(uniqueKey)) {
                    seenIds.add(uniqueKey);
                    selectedRecommendations.push(item);
                }
            }
        }

        console.log('选择的推荐项:', selectedRecommendations);

        let currentIndex = 0;
        const intervalTime = 30000; // 每30秒切换一次

        // 动态创建进度条容器和进度条
        let progressBarContainer = bannerElement.querySelector('.progress-bar-container');
        if (!progressBarContainer) {
            progressBarContainer = document.createElement('div');
            progressBarContainer.className = 'progress-bar-container';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBarContainer.appendChild(progressBar);
            bannerElement.appendChild(progressBarContainer); // 插入到 banner 容器内的最下方
        }
        const progressBar = progressBarContainer.querySelector('.progress-bar');

        function showNextBannerItem() {
            const item = selectedRecommendations[currentIndex];
            if (item) {
                // 正确识别媒体类型
                const mediaType = item.media_type || (item.first_air_date ? 'tv' : 'movie');
                fetchMovieDetails(item.id, mediaType, tmdbApiKey).then(movieDetails => {
                    if (movieDetails) {
                        const bannerItem = document.createElement('div');
                        bannerItem.className = 'banner-item';

                        // 优先显示默认banner，加载成功后再显示TMDB图片
                        bannerItem.style.backgroundImage = `url(https://uapis.cn/api/v1/image/bing-daily)`;
                        if (movieDetails.backdrop_path) {
                            const tmdbBackdropUrl = `https://image.tmdb.org/t/p/original${movieDetails.backdrop_path}`;
                            const imgLoader = new Image();
                            imgLoader.onload = function() {
                                bannerItem.style.backgroundImage = `url(${tmdbBackdropUrl})`;
                            };
                            imgLoader.onerror = function() {
                                bannerItem.style.backgroundImage = `url(https://uapis.cn/api/v1/image/bing-daily)`;
                            };
                            imgLoader.src = tmdbBackdropUrl;
                        }

                        // 创建评分元素
                        const ratingElement = document.createElement('div');
                        ratingElement.className = 'rating';
                        ratingElement.textContent = movieDetails.vote_average 
                            ? movieDetails.vote_average.toFixed(1) 
                            : 'N/A';

                        // 创建内容容器
                        const contentContainer = document.createElement('div');
                        contentContainer.className = 'textcontent';

                        // 创建标题
                        const titleElement = document.createElement('p');
                        titleElement.className = 'title'; // 添加类名
                        titleElement.textContent = movieDetails.title || movieDetails.name || '无标题';

                        // 创建剧情简介
                        const overviewElement = document.createElement('p');
                        overviewElement.className = 'overview'; // 添加类名
                        overviewElement.textContent = movieDetails.overview || '无简介';

                        // 将评分、标题和简介添加到内容容器
                        bannerItem.appendChild(ratingElement); // 添加评分到右上角
                        contentContainer.appendChild(titleElement);
                        contentContainer.appendChild(overviewElement);

                        // 将内容容器添加到banner项
                        bannerItem.appendChild(contentContainer);

                        // 添加点击事件，显示模态框
                        bannerItem.addEventListener('click', () => {
                            showMovieDetails(item.id, mediaType);
                        });

                        // 将banner项添加到banner区域
                        bannerListElement.innerHTML = ''; // 清空原有内容
                        bannerListElement.appendChild(bannerItem);

                        // 添加动画效果
                        setTimeout(() => {
                            bannerItem.classList.add('active');
                        }, 10);
                    }
                });
            }

            // 更新进度条
            progressBar.style.transition = 'none'; // 禁用过渡效果以重置宽度
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.transition = `width ${intervalTime}ms linear`; // 设置过渡效果
                progressBar.style.width = '100%';
            }, 50);

            // 更新当前索引
            currentIndex = (currentIndex + 1) % selectedRecommendations.length;
        }

        // 初始显示
        showNextBannerItem();

        // 每隔30秒切换下一个推荐项
        setInterval(showNextBannerItem, intervalTime);
    }

    // 检查 TMDB API Key 是否有效
    function checkApiKeyValidity(apiKey) {
        const url = `https://api.tmdb.org/3/genre/movie/list?api_key=${apiKey}&language=zh-CN`;
        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('API Key 无效');
                }
                return response.json();
            })
            .then(data => {
                return data.genres && data.genres.length > 0;
            })
            .catch(error => {
                console.error('API Key 验证失败:', error);
                return false;
            });
    }

    // 初始化时获取推荐资源
    if (tmdbApiKey) {
        // 首先验证 API Key 是否有效
        checkApiKeyValidity(tmdbApiKey).then(isValid => {
            if (!isValid) {
                showApiError();
                return;
            }
            
            Promise.all([
                fetchTrendingMovies(tmdbApiKey),
                fetchNowPlayingMovies(tmdbApiKey),
                fetchTrendingTVShows(tmdbApiKey),
                fetchChinaMovies(tmdbApiKey),
                fetchChinaTVShows(tmdbApiKey),
                fetchTopRated(tmdbApiKey)
            ]).then(results => {
                const [trendingMovies, nowPlayingMovies, trendingTVShows, chinaMovies, chinaTVShows, topRated] = results;
                // 正确传递所有分类的数据
                populateBanner(trendingMovies, nowPlayingMovies, trendingTVShows, chinaMovies, chinaTVShows, topRated);
                hideLoading(); // 隐藏加载动画
            }).catch(error => {
                console.error('获取推荐内容时出错:', error);
                showApiError(); // 显示错误信息
            });
        });
    } else {
        console.error('TMDB API Key 未找到');
        showApiError(); // 显示错误信息
    }

    // 滚动推荐列表
    function scrollCarousel(listId, direction) {
        const listElement = document.getElementById(listId);
        if (!listElement) {
            console.error(`未找到列表元素: ${listId}`);
            return;
        }

        const itemWidth = listElement.firstElementChild 
            ? listElement.firstElementChild.offsetWidth + 20 
            : 0; // 20 是项目之间的间距
        const scrollAmount = itemWidth * 3; // 每次滚动 3 个项目

        console.log(`滚动列表: ${listId}, 方向: ${direction}, 滚动距离: ${scrollAmount}`);
        listElement.scrollLeft += direction * scrollAmount;
    }

    // 触摸滑动事件处理
    document.querySelectorAll('.movie-list, .tv-list').forEach(list => {
        let startX = 0;
        let scrollLeft = 0;

        list.addEventListener('touchstart', (e) => {
            startX = e.touches[0].pageX; // 记录触摸起点
            scrollLeft = list.scrollLeft; // 记录当前滚动位置
        });

        list.addEventListener('touchmove', (e) => {
            const deltaX = e.touches[0].pageX - startX; // 计算滑动距离
            list.scrollLeft = scrollLeft - deltaX; // 更新滚动位置
        });
    });

    // 显示 Toast 消息
    function showToast(message, isSuccess = true) {
        const toastElement = document.querySelector('.toast');
        const toastMessage = document.getElementById('toastMessage');
        toastMessage.textContent = message;

        // 显示 Toast
        const toast = new bootstrap.Toast(toastElement);
        toast.show();

        // 2秒后自动隐藏
        setTimeout(() => {
            toast.hide();
        }, 2000);
    }

    // 详情模态框，优先显示默认图片，加载成功后再显示 TMDB 图片
    function showMovieDetails(tmdbId, mediaType) {
        fetchMovieDetails(tmdbId, mediaType, tmdbApiKey).then(movieDetails => {
            if (movieDetails) {
                // 填充模态框内容
                const modalPoster = document.getElementById('modalPoster');
                modalPoster.src = '/static/img/no-image.png';
                if (movieDetails.poster_path) {
                    const tmdbPosterUrl = `https://image.tmdb.org/t/p/w500${movieDetails.poster_path}`;
                    const imgLoader = new Image();
                    imgLoader.onload = function() {
                        modalPoster.src = tmdbPosterUrl;
                    };
                    imgLoader.onerror = function() {
                        modalPoster.src = '/static/img/no-image.png';
                    };
                    imgLoader.src = tmdbPosterUrl;
                }
                document.getElementById('modalTitle').textContent = movieDetails.title || movieDetails.name || '无标题';

                // 填充评分数据，保留小数点后一位
                document.getElementById('modalRating').textContent = movieDetails.vote_average 
                    ? `评分: ${movieDetails.vote_average.toFixed(1)}` 
                    : '评分: 暂无';

                // 根据 mediaType 动态显示内容
                if (mediaType === 'movie') {
                    document.getElementById('modalSeasons').style.display = 'none'; // 隐藏季数信息
                    document.getElementById('modalEpisodeCount').style.display = 'none'; // 隐藏集数信息
                    document.getElementById('modalYear').textContent = movieDetails.release_date 
                        ? `年份: ${new Date(movieDetails.release_date).getFullYear()}` 
                        : '年份: 未知';
                } else if (mediaType === 'tv') {
                    document.getElementById('modalSeasons').style.display = 'block'; // 显示季数信息
                    document.getElementById('modalEpisodeCount').style.display = 'block'; // 显示集数信息
                    document.getElementById('modalSeasons').textContent = movieDetails.number_of_seasons 
                        ? `第 ${movieDetails.number_of_seasons} 季` 
                        : '季数: 未知';
                    document.getElementById('modalEpisodeCount').textContent = movieDetails.number_of_episodes 
                        ? `共 ${movieDetails.number_of_episodes} 集` 
                        : '集数: 未知';

                    const lastSeason = movieDetails.seasons && movieDetails.seasons[movieDetails.seasons.length - 1];
                    const airDate = lastSeason && lastSeason.air_date;
                    document.getElementById('modalYear').textContent = airDate 
                        ? `年份: ${new Date(airDate).getFullYear()}` 
                        : '年份: 未知';
                }

                document.getElementById('modalOverview').textContent = movieDetails.overview || '暂无简介';

                // 设置订阅按钮的点击事件
                const subscribeButton = document.getElementById('subscribeButton');

                // 检查订阅状态
                const subscriptionData = {
                    title: movieDetails.title || movieDetails.name || '无标题',
                    year: mediaType === 'movie' 
                        ? (movieDetails.release_date ? new Date(movieDetails.release_date).getFullYear() : '未知') 
                        : (movieDetails.first_air_date ? new Date(movieDetails.first_air_date).getFullYear() : '未知'),
                    season: mediaType === 'tv' ? movieDetails.number_of_seasons || '未知' : undefined,
                    episodes: mediaType === 'tv' ? movieDetails.number_of_episodes || '未知' : undefined, // 添加集数信息
                    mediaType: mediaType, // 添加媒体类型
                    tmdbId: tmdbId // 添加tmdbId用于获取季信息
                };
                
                // 对于多季电视剧，检查所有季的订阅状态
                if (mediaType === 'tv' && movieDetails.number_of_seasons > 1) {
                    // 创建一个检查所有季订阅状态的Promise数组
                    const seasonCheckPromises = [];
                    for (let i = 1; i <= movieDetails.number_of_seasons; i++) {
                        // 获取当前季度的信息，包括正确的年份
                        const seasonSubscriptionData = {
                            ...subscriptionData,
                            season: i
                        };
                        
                        seasonCheckPromises.push(
                            // 先获取季度详细信息以获取正确的年份
                            fetch(`https://api.tmdb.org/3/tv/${tmdbId}/season/${i}?api_key=${tmdbApiKey}&language=zh-CN`)
                            .then(response => response.json())
                            .then(seasonData => {
                                // 更新年份为当前季度的年份
                                const seasonYear = seasonData.air_date ? new Date(seasonData.air_date).getFullYear() : subscriptionData.year;
                                return {
                                    ...seasonSubscriptionData,
                                    year: seasonYear
                                };
                            })
                            .catch(error => {
                                // 如果获取季度信息失败，使用原有年份
                                console.error(`获取第${i}季详细信息时出错:`, error);
                                return seasonSubscriptionData;
                            })
                            .then(data => {
                                return fetch('/check_subscriptions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(data),
                                })
                                .then(response => response.json());
                            })
                        );
                    }
                    
                    // 等待所有季的检查结果
                    Promise.all(seasonCheckPromises)
                        .then(seasonResults => {
                            // 检查是否有任何季未订阅
                            const anyUnsubscribed = seasonResults.some(result => !result.subscribed || result.status !== 'subscribed');
                            const allInLibrary = seasonResults.every(result => result.status === 'in_library');
                            
                            if (allInLibrary) {
                                // 所有季都在库中
                                subscribeButton.style.color = '#007bff';
                                subscribeButton.textContent = '已入库';
                                subscribeButton.disabled = false;
                                
                                subscribeButton.onclick = () => {
                                    showToast('该内容已在库中，无法取消订阅', false);
                                };
                            } else if (!anyUnsubscribed) {
                                // 所有季都已订阅
                                subscribeButton.style.color = '#198754';
                                subscribeButton.textContent = '已订阅';
                                subscribeButton.disabled = false;
                                
                                subscribeButton.onclick = () => {
                                    showCancelSeasonSelectionModal(subscriptionData, seasonResults);
                                };
                            } else {
                                // 有季未订阅
                                subscribeButton.style.color = '#495057';
                                subscribeButton.textContent = '订阅';
                                subscribeButton.disabled = false;
                                
                                subscribeButton.onclick = () => {
                                    showSeasonSelectionModal(movieDetails, subscriptionData, subscribeButton);
                                };
                            }
                        })
                        .catch(error => {
                            console.error('检查订阅状态时出错:', error);
                        });
                } else {
                    // 单季电视剧或电影的原有逻辑
                    fetch('/check_subscriptions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(subscriptionData),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.subscribed) {
                            if (data.status === 'subscribed') {
                                subscribeButton.style.color = '#198754';
                                subscribeButton.textContent = '已订阅';
                            } else if (data.status === 'in_library') {
                                subscribeButton.style.color = '#007bff';
                                subscribeButton.textContent = '已入库';
                            }
                            subscribeButton.disabled = false;

                            subscribeButton.onclick = () => {
                                if (data.status === 'subscribed') {
                                    cancelSubscription(subscriptionData, subscribeButton);
                                } else if (data.status === 'in_library') {
                                    showToast('该内容已在库中，无法取消订阅', false);
                                }
                            };
                        } else {
                            subscribeButton.style.color = '#495057';
                            subscribeButton.textContent = '订阅';
                            subscribeButton.disabled = false;

                            subscribeButton.onclick = () => {
                                if (mediaType === 'tv' && movieDetails.number_of_seasons > 1) {
                                    showSeasonSelectionModal(movieDetails, subscriptionData, subscribeButton);
                                } else {
                                    subscribeMedia(subscriptionData, subscribeButton);
                                }
                            };
                        }
                    })
                    .catch(error => {
                        console.error('检查订阅状态时出错:', error);
                    });
                }

                // 资源搜索函数 - 修改部分
                const searchResourceButton = document.getElementById('searchResourceButton');
                searchResourceButton.onclick = () => {
                    const searchTitle = movieDetails.title || movieDetails.name || '无标题';
                    const searchYear = mediaType === 'movie' 
                        ? (movieDetails.release_date ? new Date(movieDetails.release_date).getFullYear() : '') 
                        : (movieDetails.first_air_date ? new Date(movieDetails.first_air_date).getFullYear() : '');
                    const searchType = mediaType;
                    const tmdbId = movieDetails.id;
                    
                    // 检查是否为多季电视剧
                    if (mediaType === 'tv' && movieDetails.number_of_seasons > 1) {
                        // 显示季选择模态框用于资源搜索
                        showSeasonSearchSelectionModal(movieDetails, {
                            title: searchTitle,
                            year: searchYear,
                            type: searchType,
                            tmdbId: tmdbId
                        });
                    } else {
                        // 直接跳转到搜索页面（电影或单季电视剧）
                        let searchUrl = `/manual_search?title=${encodeURIComponent(searchTitle)}&year=${searchYear}&type=${searchType}&tmdb_id=${tmdbId}`;
                        
                        // 如果是电视剧，添加季数信息
                        if (mediaType === 'tv' && movieDetails.number_of_seasons) {
                            searchUrl += `&season=${movieDetails.number_of_seasons}`;
                        }
                        
                        // 在新标签页中打开搜索页面
                        window.open(searchUrl, '_blank');
                    }
                };

                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('mediaDetailsModal'));
                modal.show();
            }
        }).catch(error => {
            console.error('获取影片详细信息时出错:', error);
        });
    }

    // 显示季搜索选择模态框
    function showSeasonSearchSelectionModal(tvDetails, searchParams) {
        // 创建季选择模态框
        const modalHtml = `
            <div class="modal fade" id="seasonSearchSelectionModal" tabindex="-1" aria-labelledby="seasonSearchSelectionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header d-flex justify-content-between align-items-center">
                            <h5 class="modal-title" id="seasonSearchSelectionModalLabel">选择搜索季</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>《${searchParams.title}》共有 ${tvDetails.number_of_seasons} 季，请选择要搜索的季：</p>
                            <div class="season-selection">
                                ${generateSeasonOptions(tvDetails.number_of_seasons)}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-primary" id="confirmSeasonSearch">搜索</button>
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 添加模态框到页面
        if (!document.getElementById('seasonSearchSelectionModal')) {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // 显示模态框
        const seasonSearchModal = new bootstrap.Modal(document.getElementById('seasonSearchSelectionModal'));
        seasonSearchModal.show();
        
        // 绑定确认按钮事件
        document.getElementById('confirmSeasonSearch').onclick = function() {
            const selectedSeason = document.querySelector('input[name="seasonChoice"]:checked');
            if (selectedSeason) {
                const seasonNumber = parseInt(selectedSeason.value);
                seasonSearchModal.hide();
                
                // 获取该季的详细信息以获取正确的年份
                fetchSeasonDetailsForSearch(tvDetails.id, seasonNumber, searchParams);
            } else {
                showToast('请选择要搜索的季', false);
            }
        };
        
        // 模态框关闭时清理
        document.getElementById('seasonSearchSelectionModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // 获取季详细信息用于搜索
    function fetchSeasonDetailsForSearch(tvId, seasonNumber, searchParams) {
        const url = `https://api.tmdb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${tmdbApiKey}&language=zh-CN`;
        
        fetch(url)
            .then(response => response.json())
            .then(seasonData => {
                // 使用该季的年份而不是整个剧集的年份
                let seasonYear = '';
                if (seasonData.air_date) {
                    seasonYear = new Date(seasonData.air_date).getFullYear();
                }
                
                // 构造跳转URL并传递参数
                let searchUrl = `/manual_search?title=${encodeURIComponent(searchParams.title)}&year=${seasonYear}&type=${searchParams.type}&tmdb_id=${searchParams.tmdbId}&season=${seasonNumber}`;
                window.location.href = searchUrl;
            })
            .catch(error => {
                console.error('获取季详细信息时出错:', error);
                // 如果获取季信息失败，仍然使用原来的年份
                let searchUrl = `/manual_search?title=${encodeURIComponent(searchParams.title)}&year=${searchParams.year}&type=${searchParams.type}&tmdb_id=${searchParams.tmdbId}&season=${seasonNumber}`;
                window.location.href = searchUrl;
            });
    }

    // 显示季选择模态框
    function showSeasonSelectionModal(movieDetails, subscriptionData, subscribeButton) {
        // 创建季选择模态框
        const modalHtml = `
            <div class="modal fade" id="seasonSelectionModal" tabindex="-1" aria-labelledby="seasonSelectionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header d-flex justify-content-between align-items-center">
                            <h5 class="modal-title" id="seasonSelectionModalLabel">选择订阅季</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>《${subscriptionData.title}》共有 ${movieDetails.number_of_seasons} 季，请选择要订阅的季：</p>
                            <div class="season-selection">
                                ${generateSeasonOptions(movieDetails.number_of_seasons)}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-primary" id="confirmSeasonSubscription">确认</button>
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 添加模态框到页面
        if (!document.getElementById('seasonSelectionModal')) {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // 显示模态框
        const seasonModal = new bootstrap.Modal(document.getElementById('seasonSelectionModal'));
        seasonModal.show();
        
        // 绑定确认按钮事件
        document.getElementById('confirmSeasonSubscription').onclick = function() {
            const selectedSeason = document.querySelector('input[name="seasonChoice"]:checked');
            if (selectedSeason) {
                const seasonNumber = parseInt(selectedSeason.value);
                
                // 检查该季的订阅状态
                const seasonSubscriptionData = {
                    ...subscriptionData,
                    season: seasonNumber
                };
                
                fetch('/check_subscriptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(seasonSubscriptionData),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.subscribed && data.status === 'in_library') {
                        // 该季已入库
                        showToast('当前季已入库', false);
                        seasonModal.hide();
                    } else if (data.subscribed && data.status === 'subscribed') {
                        // 该季已订阅
                        showToast(`第 ${seasonNumber} 季已订阅`, false);
                        seasonModal.hide();
                    } else {
                        // 获取该季的集数信息和年份信息
                        fetchSeasonDetails(movieDetails.id, seasonNumber, subscriptionData, subscribeButton);
                        seasonModal.hide();
                    }
                })
                .catch(error => {
                    console.error('检查季订阅状态时出错:', error);
                    showToast('检查订阅状态失败，请稍后重试。', false);
                });
            } else {
                showToast('请选择要订阅的季', false);
            }
        };
        
        // 模态框关闭时清理
        document.getElementById('seasonSelectionModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // 显示取消订阅季选择模态框
    function showCancelSeasonSelectionModal(subscriptionData, seasonResults) {
        // 生成季选项，只显示已订阅的季
        let seasonOptions = '';
        seasonResults.forEach((result, index) => {
            if (result.status === 'subscribed') {
                const seasonNumber = index + 1;
                seasonOptions += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="cancelSeasonChoice" id="cancelSeason${seasonNumber}" value="${seasonNumber}">
                        <label class="form-check-label" for="cancelSeason${seasonNumber}">
                            第 ${seasonNumber} 季
                        </label>
                    </div>
                `;
            }
        });

        // 创建取消订阅季选择模态框
        const modalHtml = `
            <div class="modal fade" id="cancelSeasonSelectionModal" tabindex="-1" aria-labelledby="cancelSeasonSelectionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header d-flex justify-content-between align-items-center">
                            <h5 class="modal-title" id="cancelSeasonSelectionModalLabel">选择取消订阅的季</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>《${subscriptionData.title}》请选择要取消订阅的季：</p>
                            <div class="season-selection">
                                ${seasonOptions}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-danger" id="confirmCancelSeasonSubscription">取消订阅</button>
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 添加模态框到页面
        if (!document.getElementById('cancelSeasonSelectionModal')) {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // 显示模态框
        const cancelSeasonModal = new bootstrap.Modal(document.getElementById('cancelSeasonSelectionModal'));
        cancelSeasonModal.show();
        
        // 绑定确认按钮事件
        document.getElementById('confirmCancelSeasonSubscription').onclick = function() {
            const selectedSeasons = document.querySelectorAll('input[name="cancelSeasonChoice"]:checked');
            if (selectedSeasons.length > 0) {
                const seasonNumbers = Array.from(selectedSeasons).map(season => parseInt(season.value));
                
                // 确认是否取消订阅
                if (confirm(`确定要取消第 ${seasonNumbers.join(', ')} 季的订阅吗？`)) {
                    // 执行取消订阅
                    cancelSelectedSeasonsSubscription(subscriptionData, seasonNumbers, cancelSeasonModal);
                }
            } else {
                showToast('请选择要取消订阅的季', false);
            }
        };
        
        // 模态框关闭时清理
        document.getElementById('cancelSeasonSelectionModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // 生成季选项
    function generateSeasonOptions(seasonCount) {
        let options = '';
        for (let i = 1; i <= seasonCount; i++) {
            options += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="seasonChoice" id="season${i}" value="${i}" ${i === 1 ? 'checked' : ''}>
                    <label class="form-check-label" for="season${i}">
                        第 ${i} 季
                    </label>
                </div>
            `;
        }
        return options;
    }

    // 获取季详细信息
    function fetchSeasonDetails(tmdbId, seasonNumber, subscriptionData, subscribeButton) {
        const url = `https://api.tmdb.org/3/tv/${tmdbId}/season/${seasonNumber}?api_key=${tmdbApiKey}&language=zh-CN`;
        
        fetch(url)
            .then(response => response.json())
            .then(seasonData => {
                // 获取该季的年份信息
                let seasonYear = '';
                if (seasonData.air_date) {
                    seasonYear = new Date(seasonData.air_date).getFullYear();
                } else {
                    // 如果该季没有播出日期，则使用电视剧整体的初始年份
                    seasonYear = subscriptionData.year || '';
                }
                
                // 更新订阅数据，添加具体季数、集数和年份
                const updatedSubscriptionData = {
                    ...subscriptionData,
                    season: seasonNumber,
                    episodes: seasonData.episodes ? seasonData.episodes.length : 0,
                    year: seasonYear // 添加季的年份
                };
                
                // 执行订阅
                subscribeMedia(updatedSubscriptionData, subscribeButton);
            })
            .catch(error => {
                console.error('获取季详细信息时出错:', error);
                showToast('获取季信息失败，请稍后重试。', false);
            });
    }

    // 执行订阅的通用函数
    function subscribeMedia(subscriptionData, subscribeButton) {
        fetch('/tmdb_subscriptions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(subscriptionData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示成功消息
                showToast(data.message, true);

                // 修改按钮样式和文字为已订阅状态
                subscribeButton.style.color = '#198754';
                subscribeButton.textContent = '已订阅';
                
                // 更新按钮点击事件为取消订阅
                subscribeButton.onclick = () => {
                    cancelSubscription(subscriptionData, subscribeButton);
                };
                
                // 重新检查订阅状态以确保一致性
                setTimeout(() => {
                    fetch('/check_subscriptions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(subscriptionData),
                    })
                    .then(response => response.json())
                    .then(checkData => {
                        if (!checkData.subscribed) {
                            // 如果检查发现未订阅，恢复按钮状态
                            subscribeButton.style.color = '#495057';
                            subscribeButton.textContent = '订阅';
                            subscribeButton.onclick = () => {
                                if (subscriptionData.mediaType === 'tv' && subscriptionData.season && subscriptionData.season > 1) {
                                    fetchMovieDetails(subscriptionData.tmdbId, subscriptionData.mediaType, tmdbApiKey).then(movieDetails => {
                                        if (movieDetails) {
                                            showSeasonSelectionModal(movieDetails, subscriptionData, subscribeButton);
                                        }
                                    });
                                } else {
                                    subscribeMedia(subscriptionData, subscribeButton);
                                }
                            };
                            showToast('订阅状态异常，请重新尝试订阅', false);
                        }
                    })
                    .catch(error => {
                        console.error('检查订阅状态出错:', error);
                    });
                }, 1000); // 延迟1秒检查，确保后端处理完成
            } else {
                // 显示失败消息
                showToast(data.message, false);
            }
        })
        .catch(error => {
            console.error('订阅请求出错:', error);
            showToast('订阅失败，请稍后重试。', false);
        });
    }

    // 取消订阅的函数
    function cancelSubscription(subscriptionData, subscribeButton) {
        // 直接取消订阅，无需确认
        fetch('/cancel_subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(subscriptionData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示成功消息
                showToast(data.message, true);

                // 修改按钮样式和文字回到可订阅状态
                subscribeButton.style.color = '#495057';
                subscribeButton.textContent = '订阅';
                
                // 更新按钮点击事件为订阅
                subscribeButton.onclick = () => {
                    const mediaType = subscriptionData.mediaType;
                    // 检查是否为电视剧且有多季
                    if (mediaType === 'tv' && subscriptionData.season && subscriptionData.season > 1) {
                        // 重新获取电视剧详情以显示季选择模态框
                        fetchMovieDetails(subscriptionData.tmdbId, mediaType, tmdbApiKey).then(movieDetails => {
                            if (movieDetails) {
                                showSeasonSelectionModal(movieDetails, subscriptionData, subscribeButton);
                            }
                        });
                    } else {
                        subscribeMedia(subscriptionData, subscribeButton);
                    }
                };
            } else {
                // 显示失败消息
                showToast(data.message, false);
            }
        })
        .catch(error => {
            console.error('取消订阅请求出错:', error);
            showToast('取消订阅失败，请稍后重试。', false);
        });
    }

    // 取消选定季的订阅
    function cancelSelectedSeasonsSubscription(subscriptionData, seasonNumbers, modal) {
        // 创建取消订阅的Promise数组
        const cancelPromises = seasonNumbers.map(seasonNumber => {
            const seasonData = {
                ...subscriptionData,
                season: seasonNumber
            };
            
            return fetch('/cancel_subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(seasonData),
            }).then(response => response.json());
        });
        
        Promise.all(cancelPromises)
            .then(results => {
                const allSuccess = results.every(result => result.success);
                if (allSuccess) {
                    showToast(`第 ${seasonNumbers.join(', ')} 季已取消订阅`, true);
                    modal.hide();
                    
                    // 更新主模态框中的订阅按钮状态
                    const subscribeButton = document.getElementById('subscribeButton');
                    subscribeButton.style.color = '#495057';
                    subscribeButton.textContent = '订阅';
                    
                    // 重新绑定订阅按钮事件
                    subscribeButton.onclick = () => {
                        fetchMovieDetails(subscriptionData.tmdbId, subscriptionData.mediaType, tmdbApiKey).then(movieDetails => {
                            if (movieDetails) {
                                showSeasonSelectionModal(movieDetails, subscriptionData, subscribeButton);
                            }
                        });
                    };
                } else {
                    showToast('部分订阅取消失败，请稍后重试', false);
                }
            })
            .catch(error => {
                console.error('取消订阅请求出错:', error);
                showToast('取消订阅失败，请稍后重试。', false);
            });
    }

    // 关闭模态框时清空内容
    document.getElementById('mediaDetailsModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('modalPoster').src = '';
        document.getElementById('modalTitle').textContent = '';
        document.getElementById('modalRating').textContent = '';
        document.getElementById('modalSeasons').textContent = '';
        document.getElementById('modalEpisodeCount').textContent = '';
        document.getElementById('modalYear').textContent = '';
        document.getElementById('modalOverview').textContent = '';
        document.getElementById('modalSeasons').style.display = 'none';
        document.getElementById('modalEpisodeCount').style.display = 'none';
    });
</script>
{% endblock %}