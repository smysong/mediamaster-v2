{% extends "base.html" %}
{% block title %}资源搜索{% endblock %}
{% block content %}
<style>
.resource-table {
    background-color: white;
}

.resource-table thead th {
    background-color: white;
    border-bottom: 2px solid #dee2e6;
    cursor: pointer;
    position: relative;
    padding-right: 20px;
}

.resource-table tbody td {
    border-top: 1px solid #dee2e6;
    background-color: white;
}

.resource-table tbody tr:hover td {
    background-color: #f8f9fa;
}

.sort-indicator {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
}

.sort-indicator::before {
    content: "↕";
    opacity: 0.3;
}

.sort-indicator.asc::before {
    content: "↑";
    opacity: 1;
}

.sort-indicator.desc::before {
    content: "↓";
    opacity: 1;
}

/* 响应式海报尺寸 */
.poster-img {
    width: 100%;
    height: auto;
    object-fit: cover;
}

@media (min-width: 768px) {
    .poster-img {
        width: 120px;
        height: 180px;
    }
}

@media (max-width: 767.98px) {
    .poster-img {
        width: 100px;
        height: 150px;
    }
}

/* 响应式字体大小 */
.card-title {
    font-size: clamp(14px, 1.2vw, 16px) !important;
    font-weight: bold !important; /* 标题加粗 */
}

.card-text small {
    font-size: clamp(12px, 1.2vw, 16px) !important;
}

.card-text.text-muted {
    font-size: clamp(10px, 1.2vw, 16px) !important;
}

/* 卡片阴影效果 */
.tmdb-result-item {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 6px 20px rgba(0,0,0,0.1);
    border: none;
    margin-bottom: 1rem;
}

/* 大屏幕左对齐 */
@media (min-width: 768px) {
    .tmdb-result-item .card-title,
    .tmdb-result-item .card-text.mb-1,
    .tmdb-result-item .card-text.mb-0 {
        text-align: left !important;
    }
}

/* 小屏幕垂直布局 */
@media (max-width: 767.98px) {
    .tmdb-result-item .row.g-0 {
        flex-direction: column;
    }
    
    .tmdb-result-item .col-md-2.col-3,
    .tmdb-result-item .col-md-8.col-6,
    .tmdb-result-item .col-md-2.col-3 {
        width: 100%;
        text-align: center;
    }
    
    .tmdb-result-item .p-3 {
        padding: 1rem !important;
    }
    
    .tmdb-result-item .d-flex.align-items-center.justify-content-end {
        justify-content: center !important;
    }
    
    .tmdb-result-item .card-body {
        padding: 1rem;
    }
    
    .tmdb-result-item .card-title {
        margin-top: 0.5rem;
    }
    
    /* 小屏幕上标题和年份类型居中对齐 */
    .tmdb-result-item .card-title,
    .tmdb-result-item .card-text.mb-1 {
        text-align: center !important;
    }
    
    /* 小屏幕上简介左对齐 */
    .tmdb-result-item .card-text.mb-0 {
        text-align: left !important;
    }
}

/* 季选择模态框样式 */
.season-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.season-modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 5px;
}

.season-modal-close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.season-modal-close:hover {
    color: black;
}

.season-list {
    list-style-type: none;
    padding: 0;
}

.season-list li {
    padding: 10px;
    margin: 5px 0;
    background-color: #f8f9fa;
    border-radius: 3px;
    cursor: pointer;
}

.season-list li:hover {
    background-color: #e9ecef;
}

/* 可折叠面板样式 */
.collapse-header {
    cursor: pointer;
    background-color: #f8f9fa;
    padding: 10px 15px;
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.collapse-header:hover {
    background-color: #e9ecef;
}

.collapse-icon {
    transition: transform 0.2s;
}

.collapse-header:not(.collapsed) .collapse-icon {
    transform: rotate(180deg);
}

.results-container {
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    margin-bottom: 15px;
}

/* 复选框筛选器样式 */
.checkbox-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.checkbox-filter-group {
    display: flex;
    margin-right: 15px;
}

.checkbox-filter-group label {
    margin-left: 5px;
    margin-bottom: 0;
    font-weight: normal;
}

/* 隐藏原来的按钮 */
.site-filter-btn, .resolution-filter-btn {
    display: none;
}

  /* 进度条样式 */
  .progress-container {
      margin: 10px 0;
  }

  .progress-bar {
      height: 15px;
      background-color: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      background-image: none;
  }

  .progress-fill {
      height: 100%;
      width: 0%;
      background-color: #0d6efd;
      background-image: linear-gradient(
          45deg, 
          rgba(255, 255, 255, .15) 25%, 
          transparent 25%, 
          transparent 50%, 
          rgba(255, 255, 255, .15) 50%, 
          rgba(255, 255, 255, .15) 75%, 
          transparent 75%, 
          transparent
      );
      background-size: 1rem 1rem;
      animation: 1s steps(20) infinite barberpole;
      transition: width 0.3s ease;
  }

  @keyframes barberpole {
      from { background-position: 0 0; }
      to { background-position: 1rem 0; }
  }

.progress-text {
    text-align: center;
    font-size: 14px;
    margin-top: 5px;
}

/* 日志窗口样式 */
.log-window {
    position: fixed;
    bottom: 20px;
    right: 2px;
    width: 400px;
    height: 300px;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 1000;
    display: none;
    flex-direction: column;
}

.log-window.collapsed {
    width: 40px;
    height: 40px;
    bottom: 20px;
    right: 20px;
    cursor: pointer;
}

.log-window.collapsed .log-window-body,
.log-window.collapsed .log-window-title,
.log-window.collapsed .log-window-controls {
    display: none;
}

.log-window-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    border-radius: 5px 5px 0 0;
}

.log-window.collapsed .log-window-header {
    justify-content: center;
    padding: 0;
    border: none;
    background: none;
    height: 100%;
}

.log-window-title {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
}

.log-window-controls {
    display: flex;
    gap: 5px;
}

.log-window-body {
    flex: 1;
    font-family: 'Courier New', monospace;
    font-size: clamp(8px, 1.2vw, 12px);
    background-color: rgb(33, 37, 41);
    color: rgb(248, 249, 250);
    padding: 5px;
    word-wrap: break-word; /* 长单词换行 */
}

.log-line {
    margin: 0 0 5px 0;
    word-break: break-all; /* 强制换行 */
    white-space: normal; /* 允许正常换行 */
    line-height: 1.5;
}

/* 收起状态下的展开图标 */
.log-window.collapsed::before {
    content: "≡";
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    color: #000;
}

.log-window.collapsed:hover {
    background-color: #f0f0f0;
}

/* 确保收起状态下的点击区域 */
.log-window.collapsed .log-window-header {
    width: 100%;
    height: 100%;
}

/* 热度和文件大小显示样式 */
.info-badge {
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 75%;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
    color: #fff;
    margin: 2px;
}

.popularity-badge {
    background-color: #6c757d;
}

.popularity-high {
    background-color: #28a745; /* 绿色 */
}

.popularity-medium {
    background-color: #ffc107; /* 黄色 */
    color: #212529;
}

.popularity-low {
    background-color: #dc3545; /* 红色 */
}

.size-badge {
    background-color: #0d6efd; /* 蓝色 */
}

/* 信息列样式 */
.info-col {
    text-align: center;
    vertical-align: middle;
}
</style>

<main class="container mt-1">
    <div class="row fade-in">
        <!-- 加载指示器 -->
        <div class="loader-container">
            <div class="loader"></div>
            <div class="loading-text">请求中，请稍后...</div>
        </div>

        <div class="card mb-4">
            <div class="card-header">资源搜索</div>
            <div class="card-body">
                <form id="search-form">
                    <div class="mb-3" style="font-size: clamp(12px, 1.2vw, 16px);">
                        <label for="keyword" class="form-label">关键词</label>
                        <input class="form-control" type="text" id="keyword" placeholder="媒体标题关键词" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-outline-success search-button">搜索</button>
                </form>
            </div>
        </div>

        <!-- TMDB搜索结果卡片展示区域 -->
        <div class="card mb-4" id="tmdb-results-card" style="display: none;">
            <div class="card-header">TMDB搜索结果</div>
            <div class="card-body">
                <div class="results" id="tmdb-results">
                    <div class="tmdb-results-list" id="tmdb-results-list"></div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 季选择模态框 -->
<div id="seasonModal" class="season-modal">
    <div class="season-modal-content">
        <span class="season-modal-close">&times;</span>
        <h5>选择季数</h5>
        <p id="seasonModalTitle"></p>
        <ul id="seasonList" class="season-list"></ul>
    </div>
</div>

<script>
    // 日志变量声明
    let logWindow = null;
    let progressInterval = null;
    let currentTaskId = null;
    // 从模板获取 TMDB API 密钥
    const tmdbApiKey = "{{ tmdb_api_key }}";

    // 在页面加载完成后检查URL参数并自动执行搜索
    document.addEventListener('DOMContentLoaded', function() {
        // 检查URL参数并自动执行搜索
        const urlParams = new URLSearchParams(window.location.search);
        let title = urlParams.get('title');
        const year = urlParams.get('year');
        const type = urlParams.get('type');
        const tmdbId = urlParams.get('tmdb_id');
        const season = urlParams.get('season');
        
        if (title && year && type && tmdbId) {
            // 清理标题中的所有空格
            title = title.replace(/\s+/g, '');
            
            // 填充搜索表单
            document.getElementById('keyword').value = title;
            
            // 自动执行搜索
            setTimeout(() => {
                // 创建模拟的搜索结果项
                createAndTriggerSearch(title, year, type, tmdbId, season);
            }, 500);
        }
    });

    // 新增函数：创建搜索结果项并触发资源搜索
    function createAndTriggerSearch(title, year, type, tmdbId, season) {
        // 显示结果卡片
        document.getElementById('tmdb-results-card').style.display = 'block';
        
        // 创建搜索结果项
        const resultsList = document.getElementById('tmdb-results-list');
        resultsList.innerHTML = '';
        
        const resultItem = document.createElement('div');
        resultItem.className = 'tmdb-result-item card mb-3';
        resultItem.setAttribute('data-tmdb-id', tmdbId);
        resultItem.setAttribute('data-type', type);
        
        // 使用默认图片
        const defaultPosterPath = '/static/img/no-image.png';
        
        resultItem.innerHTML = `
            <div class="row g-0">
                <div class="col-md-2 col-3 p-3 d-flex justify-content-center">
                    <img src="${defaultPosterPath}" class="img-fluid rounded poster-img" alt="${title}">
                </div>
                <div class="col-md-8 col-6">
                    <div class="card-body">
                        <h5 class="card-title mb-1">${title}</h5>
                        <p class="card-text mb-1 text-muted">
                            <small>
                                ${year ? year + ' | ' : ''}
                                ${type === 'movie' ? '电影' : '电视剧'}
                            </small>
                        </p>
                        <p class="card-text mb-0 text-muted">
                            从热门推荐页面跳转的自动搜索
                        </p>
                    </div>
                </div>
                <div class="col-md-2 col-3 d-flex flex-column align-items-center justify-content-center p-3">
                    <button class="btn btn-sm btn-primary resource-search-button" 
                            data-title="${title}" 
                            data-year="${year}" 
                            data-type="${type}"
                            data-tmdb-id="${tmdbId}">
                        资源检索
                    </button>
                </div>
            </div>
            <!-- 资源搜索结果将展示在这里 -->
            <div class="resource-results-wrapper" id="resource-results-wrapper-${tmdbId}"></div>
        `;
        
        resultsList.appendChild(resultItem);
        
        // 获取并加载TMDB海报图片
        loadTmdbPosterForItem(tmdbId, type, resultItem.querySelector('.poster-img'));
        
        // 触发资源搜索
        setTimeout(() => {
            if (type === 'tv' && season) {
                // 对于电视剧，直接调用资源搜索接口
                searchResources(title, year, type, tmdbId, parseInt(season));
            } else if (type === 'tv') {
                // 对于电视剧但没有季数信息，获取季信息
                getTvSeasons(tmdbId, title, year);
            } else {
                // 对于电影，直接调用资源搜索接口
                searchResources(title, year, type, tmdbId);
            }
        }, 300);
    }

    // 为自动搜索项加载TMDB海报
    function loadTmdbPosterForItem(tmdbId, type, imgElement) {
        if (!tmdbApiKey) {
            console.log('TMDB API密钥未配置');
            return;
        }

        const tmdbUrl = type === 'movie' 
            ? `https://api.tmdb.org/3/movie/${tmdbId}?api_key=${tmdbApiKey}&language=zh-CN`
            : `https://api.tmdb.org/3/tv/${tmdbId}?api_key=${tmdbApiKey}&language=zh-CN`;

        fetch(tmdbUrl)
            .then(response => response.json())
            .then(data => {
                if (data.poster_path) {
                    const posterUrl = `https://image.tmdb.org/t/p/w500${data.poster_path}`;
                    const tempImage = new Image();
                    tempImage.onload = function() {
                        imgElement.src = posterUrl;
                    };
                    tempImage.onerror = function() {
                        console.log('Failed to load TMDB poster for item');
                    };
                    tempImage.src = posterUrl;
                }
            })
            .catch(error => {
                console.error('Error loading TMDB poster:', error);
            });
    }

    // 存储当前正在处理的电视剧信息
    let currentTvInfo = null;

    // 存储电视剧的季信息
    let tvSeasonsCache = {};

    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();

        // 显示加载指示器
        showLoader();

        // 清理关键词中的所有空格：去除首尾空格，并移除中间的所有空格
        let keyword = document.getElementById('keyword').value.replace(/\s+/g, '');

        // 如果关键词为空则不继续执行
        if (!keyword) {
            showToast('请输入有效的搜索关键词');
            hideLoader();
            return;
        }

        // 直接使用从模板传递的 TMDB API 密钥
        if (!tmdbApiKey) {
            showToast('TMDB API密钥未配置，请在系统设置中配置TMDB API密钥。');
            hideLoader();
            return;
        }

        // 使用TMDB API进行搜索
        const movieUrl = `https://api.tmdb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(keyword)}&language=zh-CN`;
        const tvUrl = `https://api.tmdb.org/3/search/tv?api_key=${tmdbApiKey}&query=${encodeURIComponent(keyword)}&language=zh-CN`;

        // 并行请求电影和电视剧数据
        Promise.all([
            fetch(movieUrl).then(response => response.json()),
            fetch(tvUrl).then(response => response.json())
        ])
        .then(([movieData, tvData]) => {
            const resultsList = document.getElementById('tmdb-results-list');
            resultsList.innerHTML = '';

            // 合并电影和电视剧结果
            const allResults = [];
            
            if (movieData.results) {
                movieData.results.forEach(item => {
                    allResults.push({
                        id: item.id,
                        title: item.title,
                        original_title: item.original_title,
                        year: item.release_date ? item.release_date.substring(0, 4) : '',
                        release_date: item.release_date,
                        overview: item.overview,
                        poster_path: item.poster_path,
                        type: 'movie',
                        vote_average: item.vote_average
                    });
                });
            }

            if (tvData.results) {
                tvData.results.forEach(item => {
                    allResults.push({
                        id: item.id,
                        title: item.name,
                        original_title: item.original_name,
                        year: item.first_air_date ? item.first_air_date.substring(0, 4) : '',
                        release_date: item.first_air_date,
                        overview: item.overview,
                        poster_path: item.poster_path,
                        type: 'tv',
                        vote_average: item.vote_average
                    });
                });
            }

            if (allResults.length === 0) {
                resultsList.innerHTML = '<div class="col-12"><p class="text-center">没有找到相关结果。</p></div>';
            } else {
                // 创建垂直排列的结果列表
                allResults.forEach(item => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'tmdb-result-item card mb-3';
                    resultItem.setAttribute('data-tmdb-id', item.id);
                    resultItem.setAttribute('data-type', item.type);
                    
                    // 使用默认图片作为初始图片
                    const defaultPosterPath = '/static/img/no-image.png';
                    const tmdbPosterPath = item.poster_path 
                        ? `https://image.tmdb.org/t/p/w500${item.poster_path}` 
                        : defaultPosterPath;
                    
                    resultItem.innerHTML = `
                        <div class="row g-0">
                            <div class="col-md-2 col-3 p-3 d-flex justify-content-center">
                                <img src="${defaultPosterPath}" data-src="${tmdbPosterPath}" class="img-fluid rounded poster-img lazy-poster" alt="${item.title}">
                            </div>
                            <div class="col-md-8 col-6">
                                <div class="card-body">
                                    <h5 class="card-title mb-1">${item.title}</h5>
                                    <p class="card-text mb-1 text-muted">
                                        <small>
                                            ${item.year ? item.year + ' | ' : ''}
                                            ${item.type === 'movie' ? '电影' : '电视剧'}
                                        </small>
                                    </p>
                                    <p class="card-text mb-0 text-muted">
                                        ${item.overview ? item.overview.substring(0, 150) + (item.overview.length > 150 ? '...' : '') : '暂无简介'}
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-2 col-3 d-flex flex-column align-items-center justify-content-center p-3">
                                <button class="btn btn-sm btn-primary resource-search-button" 
                                        data-title="${item.title}" 
                                        data-year="${item.year}" 
                                        data-type="${item.type}"
                                        data-tmdb-id="${item.id}">
                                    资源检索
                                </button>
                            </div>
                        </div>
                        <!-- 资源搜索结果将展示在这里 -->
                        <div class="resource-results-wrapper" id="resource-results-wrapper-${item.id}"></div>
                    `;
                    resultsList.appendChild(resultItem);
                    
                    // 加载TMDB海报图
                    loadTMDBPoster(resultItem.querySelector('.lazy-poster'));
                });

                // 为所有"资源检索"按钮添加事件监听器
                document.querySelectorAll('.resource-search-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const title = this.getAttribute('data-title');
                        const year = this.getAttribute('data-year');
                        const type = this.getAttribute('data-type');
                        const tmdbId = this.getAttribute('data-tmdb-id');
                        
                        if (type === 'tv') {
                            // 对于电视剧，先获取季信息
                            getTvSeasons(tmdbId, title, year);
                        } else {
                            // 对于电影，直接调用资源搜索接口
                            searchResources(title, year, type, tmdbId);
                        }
                    });
                });
            }

            document.getElementById('tmdb-results-card').style.display = 'block';
            hideLoader();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('搜索过程中发生错误，请重试。');
            hideLoader();
        });
    });

    // 获取电视剧季信息
    function getTvSeasons(tmdbId, title, year) {
        showLoader();
        
        // 如果缓存中已有季信息，直接使用
        if (tvSeasonsCache[tmdbId]) {
            hideLoader();
            const validSeasons = tvSeasonsCache[tmdbId];
            if (validSeasons.length === 1) {
                // 只有一季，直接搜索
                const seasonNumber = validSeasons[0].season_number;
                const seasonYear = validSeasons[0].air_date ? validSeasons[0].air_date.substring(0, 4) : year;
                searchResources(title, seasonYear, 'tv', tmdbId, seasonNumber);
            } else {
                // 多季情况，显示季选择模态框
                showSeasonModal(tmdbId, title, year, validSeasons);
            }
            return;
        }
        
        const seasonsUrl = `https://api.tmdb.org/3/tv/${tmdbId}?api_key=${tmdbApiKey}&language=zh-CN`;
        
        fetch(seasonsUrl)
            .then(response => response.json())
            .then(data => {
                hideLoader();
                
                if (!data.seasons || data.seasons.length === 0) {
                    showToast('未找到该剧集的季信息。');
                    return;
                }
                
                // 过滤掉没有季号的特殊季（如预告片等）
                const validSeasons = data.seasons.filter(season => season.season_number >= 0);
                
                // 缓存季信息
                tvSeasonsCache[tmdbId] = validSeasons;
                
                if (validSeasons.length === 1) {
                    // 只有一季，直接搜索
                    const seasonNumber = validSeasons[0].season_number;
                    const seasonYear = validSeasons[0].air_date ? validSeasons[0].air_date.substring(0, 4) : year;
                    searchResources(title, seasonYear, 'tv', tmdbId, seasonNumber);
                } else {
                    // 多季情况，显示季选择模态框
                    showSeasonModal(tmdbId, title, year, validSeasons);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideLoader();
                showToast('获取季信息时发生错误，请重试。');
            });
    }

    // 显示季选择模态框
    function showSeasonModal(tmdbId, title, year, seasons, forceRefresh = false) {
        const modal = document.getElementById('seasonModal');
        const modalTitle = document.getElementById('seasonModalTitle');
        const seasonList = document.getElementById('seasonList');
        const closeModal = document.querySelector('.season-modal-close');
        
        modalTitle.textContent = `电视剧: ${title}`;
        seasonList.innerHTML = '';
        
        // 保存当前电视剧信息
        currentTvInfo = { tmdbId, title, year };
        
        seasons.forEach(season => {
            const listItem = document.createElement('li');
            listItem.textContent = `${season.season_number === 0 ? '特别篇' : `第 ${season.season_number} 季`} (${season.air_date ? season.air_date.substring(0, 4) : '未知年份'})`;
            listItem.addEventListener('click', () => {
                const seasonNumber = season.season_number;
                const seasonYear = season.air_date ? season.air_date.substring(0, 4) : year;
                searchResources(title, seasonYear, 'tv', tmdbId, seasonNumber, forceRefresh);
                modal.style.display = 'none';
            });
            seasonList.appendChild(listItem);
        });
        
        // 显示模态框
        modal.style.display = 'block';
        
        // 关闭模态框事件
        closeModal.onclick = function() {
            modal.style.display = 'none';
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    }

    // 加载TMDB海报图
    function loadTMDBPoster(imgElement) {
        const tmdbPosterSrc = imgElement.getAttribute('data-src');
        if (tmdbPosterSrc && tmdbPosterSrc !== '/static/images/no-image.png') {
            const tempImage = new Image();
            tempImage.onload = function() {
                imgElement.src = tmdbPosterSrc;
            };
            tempImage.onerror = function() {
                // 如果TMDB图片加载失败，保持默认图片
                console.log('Failed to load TMDB poster, keeping default image');
            };
            tempImage.src = tmdbPosterSrc;
        }
    }

    // 调用资源搜索接口（流式版本）
    function searchResources(title, year, type, tmdbId, season = null, forceRefresh = false) {
        // 清理标题中的所有空格
        title = title.replace(/\s+/g, '');
        
        showLoader(); // 显示加载指示器

        const apiUrl = '/api/search_media';

        // 构建请求数据
        const requestData = { title: title, year: year, type: type, force_refresh: forceRefresh };
        if (season !== null) {
            requestData.season = season;
        }

        // 生成唯一的容器ID
        const containerId = season !== null ? 
            `resource-results-${tmdbId}-S${season}` : 
            `resource-results-${tmdbId}`;
        
        // 获取结果包装器
        const resultsWrapper = document.getElementById(`resource-results-wrapper-${tmdbId}`);
        
        // 检查是否已存在相同的结果面板
        let existingContainer = document.getElementById(containerId);
        if (existingContainer && !forceRefresh) {
            // 如果已存在且不是强制刷新，清空内容
            existingContainer.querySelector('.resource-results-table tbody').innerHTML = '';
        } else if (forceRefresh) {
            // 如果是强制刷新，移除所有已存在的结果容器
            const allContainers = resultsWrapper.querySelectorAll('[id^="resource-results-"]');
            allContainers.forEach(container => {
                if (container.id !== containerId) {
                    container.remove();
                }
            });
            
            // 如果当前容器存在，清空内容
            if (existingContainer) {
                existingContainer.querySelector('.resource-results-table tbody').innerHTML = '';
            } else {
                // 创建新的结果容器
                createResultContainer(resultsWrapper, containerId, season);
            }
        } else {
            // 创建新的结果容器
            createResultContainer(resultsWrapper, containerId, season);
        }
        
        // 使用 fetch API 处理流式响应
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 隐藏加载指示器，请求发送后隐藏
            setTimeout(() => {
                hideLoader();
            }, 2000); // 延时2秒后隐藏加载指示器
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';
            
            // 存储收集到的结果数据
            const collectedResults = {};
            const siteNameMap = {
                'BT0': '不太灵影视',
                'GY': '观影',
                'BTYS': 'BT影视',
                'BTHD': '高清影视之家',
                'HDTV': '高清剧集网'
            };
            
            // 标记是否已接收到有效数据
            let validDataReceived = false;
            
            // 进度跟踪 - 分为4个阶段
            let progressStage = 0; // 0-4, 对应 0/4 到 4/4
            
            // 跟踪站点搜索状态
            const siteSearchStatus = {
                'BT0': false,
                'GY': false,
                'BTYS': false,
                'BTHD': false,
                'HDTV': false
            };
            
            let completedSites = 0;
            const totalSites = Object.keys(siteSearchStatus).length;
            let searchStarted = false;
            
            function updateProgressByStage(stage, message) {
                progressStage = stage;
                updateProgress(containerId, 100, message); // 保持进度条为100%
            }
            
            function updateSiteProgress(site, isCompleted) {
                // 如果站点状态发生变化
                if (siteSearchStatus[site] !== isCompleted) {
                    siteSearchStatus[site] = isCompleted;
                    
                    if (isCompleted) {
                        completedSites++;
                    } else {
                        completedSites = Math.max(0, completedSites - 1);
                    }
                    
                    // 当至少有一个站点开始搜索时，更新到阶段2
                    if (!searchStarted && (completedSites > 0 || Object.values(siteSearchStatus).some(status => status))) {
                        searchStarted = true;
                        updateProgressByStage(2, `正在搜索资源...`);
                    }
                    
                    // 当所有站点都完成时，更新到阶段3
                    if (completedSites === totalSites) {
                        updateProgressByStage(3, '搜索完成，正在处理结果...');
                    }
                }
            }
            
            function readStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        // 搜索完成，隐藏进度条和进度提示
                        const progressContainer = document.querySelector(`#collapse-${containerId} .progress-container`);
                        if (progressContainer) {
                            progressContainer.style.display = 'none';
                        }
                        return;
                    }
                    
                    // 将接收到的数据添加到缓冲区
                    buffer += decoder.decode(value, { stream: true });
                    
                    // 按行处理数据
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // 保留不完整的行
                    
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.status === 'start') {
                                    updateProgressByStage(0, '准备搜索...');
                                } else if (data.status === 'cache_found') {
                                    updateProgressByStage(1, '发现缓存结果，正在加载...');
                                } else if (data.status === 'no_cache') {
                                    updateProgressByStage(1, forceRefresh ? '强制刷新，开始实时搜索' : '开始搜索资源...');
                                    searchStarted = true;
                                } else if (data.status === 'progress') {
                                    // 使用映射后的站点名称
                                    let message = data.message;
                                    let siteFound = false;
                                    for (const [siteKey, siteName] of Object.entries(siteNameMap)) {
                                        const sitePattern = new RegExp(`站点 ${siteKey}`, 'g');
                                        if (sitePattern.test(message)) {
                                            siteFound = true;
                                            message = message.replace(sitePattern, `站点 ${siteName}`);
                                            // 当站点开始搜索时更新进度
                                            updateSiteProgress(siteKey, false);
                                        }
                                    }
                                    updateProgress(containerId, 100, message); // 保持进度条为100%
                                } else if (data.status === 'result') {
                                    // 更新站点完成状态（无论是否有结果）
                                    if (data.site) {
                                        updateSiteProgress(data.site, true);
                                    }
                                    
                                    // 只有在收到非空数据时才认为是有效数据
                                    if (data.data && data.data.length > 0) {
                                        // 收集结果数据
                                        if (!collectedResults[data.site]) {
                                            collectedResults[data.site] = [];
                                        }
                                        collectedResults[data.site] = collectedResults[data.site].concat(data.data);
                                        
                                        // 更新进度和显示结果
                                        const siteName = siteNameMap[data.site] || data.site;
                                        displayResults(containerId, collectedResults, tmdbId, season, forceRefresh);
                                    }
                                } else if (data.status === 'complete') {
                                    updateProgressByStage(4, '搜索完成');
                                    // 搜索完成，隐藏进度条和进度提示
                                    const progressContainer = document.querySelector(`#collapse-${containerId} .progress-container`);
                                    if (progressContainer) {
                                        progressContainer.style.display = 'none';
                                    }
                                    // 显示最终结果
                                    displayResults(containerId, collectedResults, tmdbId, season, forceRefresh);
                                } else if (data.status === 'error') {
                                    updateProgress(containerId, 100, data.message); // 保持进度条为100%
                                    showToast(data.message);
                                    // 出现错误，隐藏进度条和进度提示
                                    const progressContainer = document.querySelector(`#collapse-${containerId} .progress-container`);
                                    if (progressContainer) {
                                        progressContainer.style.display = 'none';
                                    }
                                    // 显示结果（包括错误情况）
                                    displayResults(containerId, collectedResults, tmdbId, season, forceRefresh);
                                }
                            } catch (e) {
                                console.error('Error parsing JSON:', e);
                            }
                        }
                    });
                    
                    // 继续读取流
                    readStream();
                }).catch(error => {
                    console.error('Stream reading error:', error);
                    updateProgress(containerId, 100, '连接错误'); // 保持进度条为100%
                    showToast('搜索过程中发生连接错误');
                    // 出现错误，隐藏进度条和进度提示
                    const progressContainer = document.querySelector(`#collapse-${containerId} .progress-container`);
                    if (progressContainer) {
                        progressContainer.style.display = 'none';
                    }
                    // 显示结果（包括错误情况）
                    displayResults(containerId, collectedResults, tmdbId, season, forceRefresh);
                });
            }
            
            readStream();
        })
        .catch(error => {
            console.error('Fetch error:', error);
            updateProgress(containerId, 100, '连接错误'); // 保持进度条为100%
            showToast('搜索过程中发生连接错误');
            // 出现错误，隐藏进度条和进度提示
            const progressContainer = document.querySelector(`#collapse-${containerId} .progress-container`);
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            // 隐藏加载指示器
            hideLoader();
            // 显示结果（包括错误情况）
            displayResults(containerId, {}, tmdbId, season, forceRefresh);
        });
    }

    // 创建结果容器
    function createResultContainer(resultsWrapper, containerId, season) {
        const resultContainer = document.createElement('div');
        resultContainer.id = containerId;
        resultContainer.className = 'resource-results-container';
        resultContainer.innerHTML = `
            <div class="collapse-header" data-bs-toggle="collapse" data-bs-target="#collapse-${containerId}" aria-expanded="true">
                <span>${season !== null ? `第 ${season} 季资源搜索结果` : '资源搜索结果'}</span>
                <span class="collapse-icon">▼</span>
            </div>
            <div id="collapse-${containerId}" class="collapse show results-container">
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill-${containerId}" style="width: 100%"></div>
                        </div>
                        <div class="progress-text" id="progress-text-${containerId}">准备搜索...</div>
                    </div>
                    <div class="resource-filters mb-3" id="filters-${containerId}"></div>
                    <div class="resource-results-table">
                        <table class="table table-sm resource-table">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 70%; word-break: break-all;" class="sortable" data-sort="title">
                                        标题
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th scope="col" style="width: 15%; word-break: break-all;" class="sortable" data-sort="info">
                                        信息
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th scope="col" style="width: 15%; word-break: break-all;" class="sortable" data-sort="site">
                                        操作
                                        <span class="sort-indicator"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="resource-tbody-${containerId}"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // 将新容器添加到结果包装器的顶部
        resultsWrapper.insertBefore(resultContainer, resultsWrapper.firstChild);
    }

    // 更新进度条
    function updateProgress(containerId, percentage, message) {
        const progressFill = document.getElementById(`progress-fill-${containerId}`);
        const progressText = document.getElementById(`progress-text-${containerId}`);
        
        // 保持进度条为100%
        progressFill.style.width = '100%';
        
        progressText.textContent = message;
    }

    // 格式化资源标题，移除文件大小等冗余信息
    function formatResourceTitle(title) {
        // 移除常见的文件大小格式，如 [1.2GB], [1024MB] 等，以及结尾处的文件大小如 3.90GB
        return title.replace(/\[\d+\.?\d*\s*[MG]B\]/gi, '')  // 移除 [1.2GB] 或 [1024MB] 格式
                    .replace(/\[([^\]]*?)\]$/g, '')         // 移除结尾的方括号内容
                    .replace(/\s*\d+\.?\d*\s*[MG]B$/gi, '') // 移除结尾处的文件大小信息，如 3.90GB
                    .trim();
    }

    // 显示结果
    function displayResults(containerId, results, tmdbId, season, forceRefresh) {
        const resourceTbody = document.getElementById(`resource-tbody-${containerId}`);
        const filtersContainer = document.getElementById(`filters-${containerId}`);
        const tableContainer = document.querySelector(`#collapse-${containerId} .resource-results-table`);
        
        // 清空现有内容
        resourceTbody.innerHTML = '';
        filtersContainer.innerHTML = '';
        
        // 收集所有站点和分辨率信息
        const sites = new Set();
        const resolutions = new Set();
        const resourceItems = [];
        
        // 检查是否有任何结果数据
        let totalResults = 0;
        for (const site in results) {
            totalResults += results[site].length;
        }
        
        // 遍历数据并收集信息
        for (const site in results) {
            sites.add(site);
            results[site].forEach(item => {
                if (item.resolution) {
                    resolutions.add(item.resolution);
                }
                resourceItems.push({
                    site: site,
                    ...item
                });
            });
        }
        
        // 如果没有结果，或者所有站点返回空数据，显示提示信息，隐藏表格
        if (totalResults === 0) {
            // 隐藏表格容器
            if (tableContainer) {
                tableContainer.style.display = 'none';
            }
            
            // 在结果容器中直接显示提示信息
            const noResultsContainer = document.createElement('div');
            noResultsContainer.className = 'no-results-message';
            noResultsContainer.innerHTML = `
                <div class="alert alert-info mb-0">
                    未找到相关资源，请尝试其他关键词或稍后再试
                </div>
            `;
            
            // 插入到过滤器容器之前
            const container = document.querySelector(`#collapse-${containerId} .card-body`);
            if (container) {
                container.insertBefore(noResultsContainer, filtersContainer);
            }
            
            return;
        }
        
        // 如果有结果，确保表格可见
        if (tableContainer) {
            tableContainer.style.display = '';
        }
        
        // 创建站点筛选复选框
        if (sites.size > 0) {
            const siteFilterDiv = document.createElement('div');
            siteFilterDiv.className = 'checkbox-filters';
            siteFilterDiv.innerHTML = '<strong style="width: 100%;">站点筛选:</strong>';
            
            // 站点名称映射表
            const siteNameMap = {
                'BT0': '不太灵影视',
                'GY': '观影',
                'BTYS': 'BT影视',
                'BTHD': '高清影视之家',
                'HDTV': '高清剧集网'
            };
            
            sites.forEach(site => {
                const filterGroup = document.createElement('div');
                filterGroup.className = 'checkbox-filter-group';
                const siteName = siteNameMap[site] || site;
                filterGroup.innerHTML = `
                    <input class="form-check-input site-filter-checkbox" type="checkbox" 
                        id="site-${site}-${containerId}" data-site="${site}" 
                        data-container-id="${containerId}" checked>
                    <label class="form-check-label" for="site-${site}-${containerId}">
                        ${siteName}
                    </label>
                `;
                filterGroup.querySelector('input').addEventListener('change', toggleSiteFilter);
                siteFilterDiv.appendChild(filterGroup);
            });
            
            filtersContainer.appendChild(siteFilterDiv);
        }
        
        // 创建分辨率筛选复选框
        if (resolutions.size > 0) {
            const resolutionFilterDiv = document.createElement('div');
            resolutionFilterDiv.className = 'checkbox-filters';
            resolutionFilterDiv.innerHTML = '<strong style="width: 100%;">质量筛选:</strong>';
            
            resolutions.forEach(resolution => {
                const filterGroup = document.createElement('div');
                filterGroup.className = 'checkbox-filter-group';
                filterGroup.innerHTML = `
                    <input class="form-check-input resolution-filter-checkbox" type="checkbox" 
                        id="resolution-${resolution}-${containerId}" data-resolution="${resolution}" 
                        data-container-id="${containerId}" checked>
                    <label class="form-check-label" for="resolution-${resolution}-${containerId}">
                        ${resolution}
                    </label>
                `;
                filterGroup.querySelector('input').addEventListener('change', toggleResolutionFilter);
                resolutionFilterDiv.appendChild(filterGroup);
            });
            
            filtersContainer.appendChild(resolutionFilterDiv);
        }
        
        // 生成资源表格行
        resourceItems.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'resource-item';
            row.setAttribute('data-site', item.site);
            row.setAttribute('data-resolution', item.resolution || '');
            row.setAttribute('data-container-id', containerId);
            
            // 根据热度值设置样式类
            let popularityBadge = '';
            if (item.popularity !== undefined) {
                let popularityClass = 'popularity-low';
                if (item.popularity >= 100) {
                    popularityClass = 'popularity-high';
                } else if (item.popularity >= 30) {
                    popularityClass = 'popularity-medium';
                }
                popularityBadge = `<span class="info-badge popularity-badge ${popularityClass}" title="热度: ${item.popularity}">${item.popularity}</span>`;
            }
            
            // 文件大小徽章
            let sizeBadge = '';
            if (item.size) {
                sizeBadge = `<span class="info-badge size-badge" title="文件大小: ${item.size}">${item.size}</span>`;
            }
            
            row.innerHTML = `
                <td class="search_titles" style="text-align:left;"><a href="${item.link}" target="_blank">${formatResourceTitle(item.title)}</a></td>
                <td class="info-col">${sizeBadge}${popularityBadge}</td>
                <td><button class="btn btn-sm btn-primary download-button" data-link="${item.link}" data-title="${item.title}" data-site="${item.site}">下载</button></td>
            `;
            resourceTbody.appendChild(row);
        });
        
        // 下载按钮点击事件监听器
        resourceTbody.querySelectorAll('.download-button').forEach(button => {
            button.addEventListener('click', function() {
                showLoader();

                const link = this.getAttribute('data-link');
                const title = this.getAttribute('data-title');
                const site = this.getAttribute('data-site');

                fetch('/api/download_resource', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ site, title, link })
                })
                .then(response => {
                    // 检查响应是否为JSON格式
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        throw new Error('服务器返回了非JSON响应');
                    }
                })
                .then(data => {
                    if (data.task_id) {
                        // 延迟2秒后隐藏加载指示器
                        setTimeout(hideLoader, 2000);
                        // 显示后台下载提示
                        showToast('开始后台执行下载任务，可在日志窗口查看进度');
                        // 保存任务ID
                        currentTaskId = data.task_id;
                        // 显示日志窗口
                        showLogWindow();
                        // 开始获取下载进度
                        startDownloadProgress(data.task_id);
                    } else if (data.error) {
                        showToast(data.error); // 显示错误消息
                        hideLoader();
                    } else {
                        showToast('未知响应格式');
                        hideLoader();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('下载过程中发生错误，请重试。');
                    hideLoader();
                });
            });
        });

        // 开始获取下载进度函数
        function startDownloadProgress(taskId) {
            // 如果已有进度更新在运行，先清除
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            // 清空日志窗口内容
            const content = document.getElementById('log-content');
            if (content) {
                content.innerHTML = '';
            }
            
            // 每1秒获取一次进度更新
            let lastMessages = [];
            progressInterval = setInterval(() => {
                fetch(`/api/download_progress/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.messages) {
                            // 检查是否有新消息
                            const newMessages = data.messages.filter(msg => !lastMessages.includes(msg));
                            if (newMessages.length > 0) {
                                newMessages.forEach(msg => {
                                    updateLogWindow(msg);
                                });
                                // 更新已显示消息列表
                                lastMessages = [...data.messages];
                            }
                        }
                    })
                    .catch(error => {
                        console.error('获取进度失败:', error);
                    });
            }, 1000);
        }

        // 显示日志窗口
        function showLogWindow() {
            if (!logWindow) {
                logWindow = document.createElement('div');
                logWindow.id = 'log-window';
                logWindow.className = 'log-window';
                logWindow.innerHTML = `
                    <div class="log-window-header">
                        <h5 class="log-window-title">种子下载日志</h5>
                        <div class="log-window-controls">
                            <button id="toggle-log-window" class="btn btn-sm btn-outline-secondary">收起</button>
                            <button id="close-log-window" class="btn btn-sm btn-outline-secondary">关闭</button>
                        </div>
                    </div>
                    <div class="log-window-body">
                        <div class="log-content" id="log-content" style="max-height: 30vh; overflow-y: auto; padding-bottom: 10px;">
                            <p class="log-line">等待任务开始...</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(logWindow);
                
                // 添加事件监听器
                document.getElementById('close-log-window').addEventListener('click', closeLogWindow);
                document.getElementById('toggle-log-window').addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    toggleLogWindow();
                });
                
                // 为收起状态的窗口添加点击事件
                logWindow.addEventListener('click', function(e) {
                    if (logWindow.classList.contains('collapsed')) {
                        toggleLogWindow();
                    }
                });
            } else {
                // 清空之前的内容
                const content = document.getElementById('log-content');
                if (content) {
                    content.innerHTML = '<p class="log-line">> 等待任务开始...</p>';
                }
                
                // 确保窗口是展开状态
                logWindow.classList.remove('collapsed');
            }
            
            logWindow.style.display = 'flex';
        }

        // 关闭日志窗口
        function closeLogWindow() {
            if (logWindow) {
                logWindow.style.display = 'none';
                // 停止进度更新
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                // 清空当前任务ID
                currentTaskId = null;
            }
        }

        // 收起/展开日志窗口
        function toggleLogWindow() {
            const toggleBtn = document.getElementById('toggle-log-window');
            if (logWindow.classList.contains('collapsed')) {
                // 展开窗口
                logWindow.classList.remove('collapsed');
                if (toggleBtn) {
                    toggleBtn.textContent = '收起';
                }
            } else {
                // 收起窗口
                logWindow.classList.add('collapsed');
                if (toggleBtn) {
                    toggleBtn.textContent = '';
                }
            }
        }

        // 更新日志窗口内容
        function updateLogWindow(message) {
            const content = document.getElementById('log-content');
            if (content) {
                // 创建DocumentFragment对象
                const fragment = document.createDocumentFragment();
                
                // 根据消息内容构建DOM节点
                const lines = message.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const p = document.createElement('p');
                    p.className = 'log-line';
                    p.textContent = line;
                    fragment.appendChild(p);
                }
                
                // 将DocumentFragment添加到content中
                content.appendChild(fragment);
                
                // 自动滚动到底部
                content.scrollTop = content.scrollHeight;
            }
        }

        // 初始化排序功能
        initSorting(containerId);
        
        // 添加重新检索按钮
        const resourceSearchButton = document.querySelector(`.resource-search-button[data-tmdb-id="${tmdbId}"]`);
        if (resourceSearchButton) {
            // 移除已存在的重新检索按钮
            const existingRefreshButton = document.querySelector(`#refresh-button-${tmdbId}`);
            if (existingRefreshButton) {
                existingRefreshButton.remove();
            }
            
            const refreshButton = document.createElement('button');
            refreshButton.id = `refresh-button-${tmdbId}`;
            refreshButton.className = 'btn btn-sm btn-outline-success mt-2';
            refreshButton.innerHTML = '重新检索';
            refreshButton.addEventListener('click', function() {
                const title = resourceSearchButton.getAttribute('data-title');
                const year = resourceSearchButton.getAttribute('data-year');
                const type = resourceSearchButton.getAttribute('data-type');
                const tmdbId = resourceSearchButton.getAttribute('data-tmdb-id');
                
                // 清空所有已存在的搜索结果
                const resultsWrapper = document.getElementById(`resource-results-wrapper-${tmdbId}`);
                if (resultsWrapper) {
                    resultsWrapper.innerHTML = '';
                }
                
                // 执行重新检索
                if (type === 'tv' && season !== null) {
                    // 对于电视剧且已知季数的情况，检查是否有多季缓存
                    if (tvSeasonsCache[tmdbId] && tvSeasonsCache[tmdbId].length > 1) {
                        // 有多季信息，显示季选择模态框，并传递forceRefresh参数
                        showSeasonModal(tmdbId, title, year, tvSeasonsCache[tmdbId], true);
                    } else {
                        // 直接重新搜索当前季，强制刷新
                        searchResources(title, year, type, tmdbId, season, true);
                    }
                } else if (type === 'tv') {
                    // 对于电视剧，需要重新获取季信息
                    getTvSeasons(tmdbId, title, year);
                } else {
                    // 对于电影，强制刷新
                    searchResources(title, year, type, tmdbId, null, true);
                }
            });
            
            // 将重新检索按钮插入到资源检索按钮的父容器中（确保在下方显示）
            const buttonContainer = resourceSearchButton.parentNode;
            buttonContainer.appendChild(refreshButton);
        }
    }

    // 初始化排序功能
    function initSorting(containerId, initialSort = false) {
        const table = document.querySelector(`#${containerId} .resource-table`);
        if (!table) return;
        
        const headers = table.querySelectorAll('.sortable');
        headers.forEach(header => {
            header.addEventListener('click', function() {
                const sortKey = this.getAttribute('data-sort');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const indicator = this.querySelector('.sort-indicator');
                
                // 确定排序方向
                let direction = 'asc';
                if (indicator.classList.contains('asc')) {
                    direction = 'desc';
                }
                
                // 清除其他列的排序指示器
                table.querySelectorAll('.sort-indicator').forEach(ind => {
                    ind.classList.remove('asc', 'desc');
                });
                
                // 设置当前列的排序指示器
                indicator.classList.toggle('asc', direction === 'asc');
                indicator.classList.toggle('desc', direction === 'desc');
                
                // 排序行
                rows.sort((a, b) => {
                    let aValue, bValue;
                    
                    if (sortKey === 'title') {
                        aValue = a.querySelector('.search_titles').textContent.trim();
                        bValue = b.querySelector('.search_titles').textContent.trim();
                    } else if (sortKey === 'info') {
                        // 获取信息列中的文本内容进行排序
                        aValue = a.querySelector('.info-col').textContent.trim();
                        bValue = b.querySelector('.info-col').textContent.trim();
                    } else if (sortKey === 'site') {
                        aValue = a.querySelector('.download-button').getAttribute('data-site');
                        bValue = b.querySelector('.download-button').getAttribute('data-site');
                    }
                    
                    if (direction === 'asc') {
                        return aValue.localeCompare(bValue, 'zh-CN');
                    } else {
                        return bValue.localeCompare(aValue, 'zh-CN');
                    }
                });
                
                // 重新插入行
                rows.forEach(row => tbody.appendChild(row));
            });
        });
        
        // 如果是初始排序，按标题默认倒序排列
        if (initialSort) {
            const titleHeader = table.querySelector('.sortable[data-sort="title"]');
            if (titleHeader) {
                // 设置标题列的排序指示器为倒序
                const indicator = titleHeader.querySelector('.sort-indicator');
                indicator.classList.add('desc');
                
                // 执行倒序排序
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                rows.sort((a, b) => {
                    const aValue = a.querySelector('.search_titles').textContent.trim();
                    const bValue = b.querySelector('.search_titles').textContent.trim();
                    return bValue.localeCompare(aValue, 'zh-CN');
                });
                
                rows.forEach(row => tbody.appendChild(row));
            }
        }
    }

    // 站点筛选切换
    function toggleSiteFilter(event) {
        const checkbox = event.target;
        const site = checkbox.getAttribute('data-site');
        const containerId = checkbox.getAttribute('data-container-id');
        
        // 获取该容器下的所有资源项
        const resourceItems = document.querySelectorAll(`.resource-item[data-container-id="${containerId}"]`);
        
        // 更新显示/隐藏状态
        resourceItems.forEach(item => {
            const itemSite = item.getAttribute('data-site');
            const siteCheckboxes = document.querySelectorAll(`.site-filter-checkbox[data-site="${itemSite}"][data-container-id="${containerId}"]`);
            
            // 检查所有相同站点的复选框是否至少有一个被选中
            const isSiteActive = Array.from(siteCheckboxes).some(cb => cb.checked);
            
            // 检查分辨率筛选状态
            const itemResolution = item.getAttribute('data-resolution');
            const resolutionCheckboxes = document.querySelectorAll(`.resolution-filter-checkbox[data-resolution="${itemResolution}"][data-container-id="${containerId}"]`);
            const isResolutionActive = resolutionCheckboxes.length === 0 || Array.from(resolutionCheckboxes).some(cb => cb.checked);
            
            // 根据站点和分辨率筛选状态决定是否显示
            if (isSiteActive && isResolutionActive) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // 分辨率筛选切换
    function toggleResolutionFilter(event) {
        const checkbox = event.target;
        const resolution = checkbox.getAttribute('data-resolution');
        const containerId = checkbox.getAttribute('data-container-id');
        
        // 获取该容器下的所有资源项
        const resourceItems = document.querySelectorAll(`.resource-item[data-container-id="${containerId}"]`);
        
        // 更新显示/隐藏状态
        resourceItems.forEach(item => {
            const itemResolution = item.getAttribute('data-resolution');
            const resolutionCheckboxes = document.querySelectorAll(`.resolution-filter-checkbox[data-resolution="${itemResolution}"][data-container-id="${containerId}"]`);
            
            // 检查所有相同分辨率的复选框是否至少有一个被选中
            const isResolutionActive = Array.from(resolutionCheckboxes).some(cb => cb.checked);
            
            // 检查站点筛选状态
            const itemSite = item.getAttribute('data-site');
            const siteCheckboxes = document.querySelectorAll(`.site-filter-checkbox[data-site="${itemSite}"][data-container-id="${containerId}"]`);
            const isSiteActive = Array.from(siteCheckboxes).some(cb => cb.checked);
            
            // 根据站点和分辨率筛选状态决定是否显示
            if (isSiteActive && isResolutionActive) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // 显示加载指示器
    function showLoader() {
        const loaderContainer = document.querySelector('.loader-container');
        loaderContainer.style.display = 'flex';
    }

    // 隐藏加载指示器
    function hideLoader() {
        const loaderContainer = document.querySelector('.loader-container');
        loaderContainer.style.display = 'none';
    }

    // 显示Toast提示框
    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastBody = document.getElementById('toastMessage');
        toastBody.textContent = message;

        // 使用Bootstrap的Toast组件来控制显示和隐藏
        const toastBootstrap = new bootstrap.Toast(toast);
        toastBootstrap.show();

        setTimeout(() => {
            toastBootstrap.hide();
        }, 3000);
    }
</script>
{% endblock %}